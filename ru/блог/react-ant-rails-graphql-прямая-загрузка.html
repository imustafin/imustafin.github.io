<!DOCTYPE html>

<html lang="ru">
  <head>
    <meta charset="UTF-8" />

    <link
      rel="alternate"
      hreflang="en"
      href="https://imustafin.tatar/en/blog/react-ant-rails-graphql-direct-upload"
    />

    <link
      rel="alternate"
      hreflang="ru"
      href="https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
    />

    <link
      rel="alternate"
      hreflang="tt"
      href="https://imustafin.tatar/tt/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-graphql-rails-%D1%82%D1%83%D1%80%D1%8B-%D0%B9%D3%A9%D0%BA%D0%BB%D3%99%D2%AF"
    />

    <!-- Begin Jekyll SEO tag v2.8.0 -->
    <title>
      Прямая загрузка файлов в Rails React Ant через GraphQL | imustafin.tatar
    </title>
    <meta name="generator" content="Jekyll v4.2.1" />
    <meta
      property="og:title"
      content="Прямая загрузка файлов в Rails React Ant через GraphQL"
    />
    <meta name="author" content="Ильгиз Мустафин" />
    <meta property="og:locale" content="ru" />
    <meta
      name="description"
      content="Реализация прямой загрузки файлов в Ruby on Rails Active Storage из React TypeScript приложения, используя Ant Design и GraphQL API."
    />
    <meta
      property="og:description"
      content="Реализация прямой загрузки файлов в Ruby on Rails Active Storage из React TypeScript приложения, используя Ant Design и GraphQL API."
    />
    <link
      rel="canonical"
      href="https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
    />
    <meta
      property="og:url"
      content="https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
    />
    <meta property="og:site_name" content="imustafin.tatar" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2020-11-09T00:00:00+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta
      property="twitter:title"
      content="Прямая загрузка файлов в Rails React Ant через GraphQL"
    />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
          "@type": "Person",
          "name": "Ильгиз Мустафин",
          "url": "https://imustafin.tatar"
        },
        "dateModified": "2020-12-03T00:00:00+00:00",
        "datePublished": "2020-11-09T00:00:00+00:00",
        "description": "Реализация прямой загрузки файлов в Ruby on Rails Active Storage из React TypeScript приложения, используя Ant Design и GraphQL API.",
        "headline": "Прямая загрузка файлов в Rails React Ant через GraphQL",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
        },
        "url": "https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
      }
    </script>
    <!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#157878" />
    <link rel="stylesheet" href="/assets/css/style.css" />

    <script
      src="https://kit.fontawesome.com/e53ce92d09.js"
      crossorigin="anonymous"
    ></script>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />
    <meta name="apple-mobile-web-app-title" content="imustafin.tatar" />
    <meta name="application-name" content="imustafin.tatar" />
    <meta name="msapplication-TileColor" content="#00aba9" />
    <meta name="theme-color" content="#ffffff" />
  </head>
  <body>
    <div class="with-header-footer">
      <section class="page-header-home">
        <h1 class="project-name">Личный сайт Мустафина Ильгиза</h1>

        <div class="navigation-wrapper">
          <div></div>

          <ul class="links menu-links">
            <li><a href="/ru/">Главная страница</a></li>

            <li><a href="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/">Блог</a></li>

            <li>
              <a href="/ru/%D1%81%D0%BB%D0%BE%D0%B2%D0%B0%D1%80%D1%8C/"
                >Словарь</a
              >
            </li>
          </ul>

          <ul class="links end-links navigation-first">
            <li>
              <a lang="en" href="/en/blog/react-ant-rails-graphql-direct-upload"
                >English</a
              >
            </li>

            <li>
              <a
                lang="ru"
                href="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
                >Русский</a
              >
            </li>

            <li>
              <a
                lang="tt"
                href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-graphql-rails-%D1%82%D1%83%D1%80%D1%8B-%D0%B9%D3%A9%D0%BA%D0%BB%D3%99%D2%AF"
                >Татарча</a
              >
            </li>
          </ul>
        </div>
      </section>

      <div class="content">
        <section class="main-content">
          <nav>
            <ol
              class="breadcrumbs"
              vocab="https://schema.org/"
              typeof="BreadcrumbList"
            >
              <li property="itemListElement" typeof="ListItem">
                <a
                  property="item"
                  typeof="WebPage"
                  href="https://imustafin.tatar/ru/"
                >
                  <span property="name">Главная страница</span>
                </a>

                <meta property="position" content="1" />
              </li>

              <li property="itemListElement" typeof="ListItem">
                <a
                  property="item"
                  typeof="WebPage"
                  href="https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/"
                >
                  <span property="name">Блог</span>
                </a>

                <meta property="position" content="2" />
              </li>

              <li property="itemListElement" typeof="ListItem">
                <span
                  property="item"
                  typeof="WebPage"
                  resource="https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
                >
                  <span property="name"
                    >Прямая загрузка файлов в Rails React Ant через
                    GraphQL</span
                  >
                </span>

                <meta property="position" content="3" />
              </li>
            </ol>
          </nav>

          <article itemscope itemtype="http://schema.org/BlogPosting">
            <header class="post-header">
              <h1 class="post-title" itemprop="name headline">
                Прямая загрузка файлов в Rails React Ant через GraphQL
              </h1>
              <p class="post-meta">
                <time
                  class="post-date"
                  datetime="2020-11-09T00:00:00+00:00"
                  itemprop="datePublished"
                >
                  9 ноября 2020
                </time>

                <span class="post-last-modified">
                  Последнее обновление:
                  <time
                    datetime="2020-12-03T00:00:00+00:00"
                    itemprop="dateModified"
                  >
                    3 декабря 2020
                  </time>
                </span>
              </p>
            </header>

            <div itemprop="articleBody">
              <p>
                Реализация прямой загрузки файлов в Ruby on Rails Active Storage
                из React TypeScript приложения, используя Ant Design и GraphQL
                API.
              </p>

              <h2 id="проблема">Проблема</h2>
              <p>
                С одной стороны, компонент Upload библиотеки Ant Design
                позволяет выбирать и загружать файлы на сервер. Обычно,
                использовать этот компонент очень легко: нужно всего лишь
                указать URL для загрузки, и Ant сделает POST запрос с
                прикреплённым файлом.
              </p>

              <div class="language-jsx highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Upload</span><span class="p">,</span> <span class="nx">Button</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">antd</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">Test</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">Upload</span>
    <span class="na">name</span><span class="p">=</span><span class="s">'avatar'</span>
    <span class="na">action</span><span class="p">=</span><span class="s">'https://example.com/avatar'</span>
  <span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nc">Button</span><span class="p">&gt;</span>Click to Upload<span class="p">&lt;/</span><span class="nc">Button</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nc">Upload</span><span class="p">&gt;</span>
<span class="p">);</span>
</code></pre>
                </div>
              </div>

              <p>
                С другой стороны, Rails предлагает создавать поле для загрузки
                файлов в представлении:
              </p>
              <div class="language-erb highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">file_field</span> <span class="ss">:avatar</span><span class="p">,</span> <span class="ss">direct_upload: </span><span class="kp">true</span> <span class="cp">%&gt;</span>
</code></pre>
                </div>
              </div>

              <p>
                В нашем проекте мы использовали представления Rails, а вся
                разметка создавалась только внутри React. Поэтому нам нужно было
                найти другой способ для загрузки файлов.
              </p>

              <h2 id="решение">Решение</h2>
              <p>
                Наше решение основано на статьях
                <a
                  href="https://evilmartians.com/chronicles/active-storage-meets-graphql-direct-uploads"
                  >Active Storage meets GraphQL: Direct Uploads</a
                >,
                <a
                  href="https://cameronbothner.com/activestorage-beyond-rails-views/"
                  >How to Use ActiveStorage Outside of a Rails View</a
                >
                и
                <a
                  href="https://cameronbothner.com/activestorage-beyond-rails-views/"
                  >этом ответе со StackOverflow</a
                >.
              </p>

              <p>
                Прямая загрузка в Acitve Storage происходит в несколько этапов:
              </p>
              <ol>
                <li>Клиент извлекает метаданные файла</li>
                <li>Клиент отправляет метаданные на Сервер</li>
                <li>Сервер подготавливает загрузку вместе с Сервисом</li>
                <li>
                  Сервер отправляет URL для загрузки и необходимые заголовки
                  Клиенту
                </li>
                <li>
                  Клиент загружает файл на Сервис, используя URL и заголовки,
                  полученные с Сервера
                </li>
              </ol>

              <p>
                В этом примере мы используем GraphQL, поэтому шаги 2, 3, 4 будут
                реализованны через GraphQL мутацию.
              </p>

              <h3 id="серверная-часть">Серверная часть</h3>

              <p>
                Параметры для прямой загрузки зависят от этих метаданных файла:
              </p>
              <ul>
                <li>Имя файла</li>
                <li>Тип данных</li>
                <li>
                  Контрольная сумма (подробнее о ней
                  <a
                    href="#%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D1%81%D0%BA%D0%B0%D1%8F-%D1%87%D0%B0%D1%81%D1%82%D1%8C"
                    >ниже</a
                  >)
                </li>
                <li>Размер файла</li>
              </ul>

              <p>
                Мы будем передавать эти данные в мутацию, а клиент в ответ будет
                получать конкретные параметры для загрузки (URL и заголовки), а
                также идентификаторы блоба.
              </p>

              <p>
                Мы используем
                <a href="https://graphql-ruby.org"
                  >гем
                  <code class="language-plaintext highlighter-rouge"
                    >graphql</code
                  ></a
                >
                для реализации GraphQL контроллера в Rails.
              </p>

              <p>
                Как мы уже говорили раньше, у нас будет мутация, которая берёт
                необходимые метаданные файла и даёт данные, необходимые для
                загрузки:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">module</span> <span class="nn">Mutations</span>
  <span class="k">class</span> <span class="nc">CreateDirectUpload</span> <span class="o">&lt;</span> <span class="no">BaseMutation</span>
    <span class="n">argument</span> <span class="ss">:filename</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>
    <span class="n">argument</span> <span class="ss">:byte_size</span><span class="p">,</span> <span class="no">Int</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>
    <span class="n">argument</span> <span class="ss">:checksum</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>
    <span class="n">argument</span> <span class="ss">:content_type</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>

    <span class="n">field</span> <span class="ss">:url</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="n">field</span> <span class="ss">:headers</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="s1">'JSON of required HTTP headers'</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="n">field</span> <span class="ss">:blob_id</span><span class="p">,</span> <span class="no">ID</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="n">field</span> <span class="ss">:signed_blob_id</span><span class="p">,</span> <span class="no">ID</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
                </div>
              </div>

              <p>
                Метод
                <code class="language-plaintext highlighter-rouge"
                  >resolve</code
                >
                будет создавать блоб и возвращать необходимые для загрузки
                данные:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">module</span> <span class="nn">Mutations</span>
  <span class="k">class</span> <span class="nc">CreateDirectUpload</span> <span class="o">&lt;</span> <span class="no">BaseMutation</span>
    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">filename</span><span class="p">:,</span> <span class="n">byte_size</span><span class="p">:,</span> <span class="n">checksum</span><span class="p">:,</span> <span class="n">content_type</span><span class="p">:)</span>
      <span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_before_direct_upload!</span><span class="p">(</span>
        <span class="ss">filename: </span><span class="n">filename</span><span class="p">,</span>
        <span class="ss">byte_size: </span><span class="n">byte_size</span><span class="p">,</span>
        <span class="ss">checksum: </span><span class="n">checksum</span><span class="p">,</span>
        <span class="ss">content_type: </span><span class="n">content_type</span>
      <span class="p">)</span>

      <span class="p">{</span>
        <span class="ss">url: </span><span class="n">blob</span><span class="p">.</span><span class="nf">service_url_for_direct_upload</span><span class="p">,</span>
        <span class="ss">headers: </span><span class="n">blob</span><span class="p">.</span><span class="nf">service_headers_for_direct_upload</span><span class="p">.</span><span class="nf">to_json</span><span class="p">,</span>
        <span class="ss">blob_id: </span><span class="n">blob</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
        <span class="ss">signed_blob_id: </span><span class="n">blob</span><span class="p">.</span><span class="nf">signed_id</span>
      <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
                </div>
              </div>

              <p>
                Теперь клиент сможет использовать эту мутацию чтобы подготовить
                прямую загрузку.
              </p>

              <h3 id="клиентская-часть">Клиентская часть</h3>
              <p>
                Все параметры мутации не требуют пояснений, за исключением
                параметра
                <code class="language-plaintext highlighter-rouge"
                  >checksum</code
                >. Строка контрольной суммы должна вычисляться по особому
                алгоритму, который доступен в
                <a href="https://www.npmjs.com/package/@rails/activestorage"
                  >пакете
                  <code class="language-plaintext highlighter-rouge"
                    >@rails/activestorage</code
                  ></a
                >.
              </p>

              <p>
                <strong>Бонус!</strong> Объявления типов для TypeScript доступны
                в
                <a
                  href="https://www.npmjs.com/package/@types/rails__activestorage"
                  >пакете
                  <code class="language-plaintext highlighter-rouge"
                    >@types/rails__activestorage</code
                  ></a
                >.
              </p>

              <div class="language-ts highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">import</span> <span class="p">{</span> <span class="nx">FileChecksum</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@rails/activestorage/src/file_checksum</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">calculateChecksum</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">:</span> <span class="nx">File</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">(</span>
  <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="nx">FileChecksum</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">checksum</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">resolve</span><span class="p">(</span><span class="nx">checksum</span><span class="p">);</span>
    <span class="p">})</span>
  <span class="p">))</span>
<span class="p">);</span>
</code></pre>
                </div>
              </div>

              <p>
                Компонент Upload библиотеки Ant принимает функцию
                <code class="language-plaintext highlighter-rouge"
                  >beforeUpload</code
                >, в которой мы и будем получать параметры для загрузки с
                сервера. В этом примере мы будем загружать один файл и будем
                сохранять необходимые параметры в состоянии компонента чтобы
                использовать их чуть позже.
              </p>
              <div class="language-ts highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">import</span> <span class="p">{</span> <span class="nx">RcFile</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">antd/lib/upload</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">class</span> <span class="nx">Test</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="k">async</span> <span class="nx">beforeUpload</span><span class="p">(</span><span class="nx">file</span><span class="p">:</span> <span class="nx">RcFile</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// createDirectUploadMutation is a placeholder for your GraphQL request method</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">headers</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">createDirectUploadMutation</span><span class="p">({</span>
      <span class="na">checksum</span><span class="p">:</span> <span class="k">await</span> <span class="nx">calculateChecksum</span><span class="p">(</span><span class="nx">file</span><span class="p">),</span>
      <span class="na">filename</span><span class="p">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span>
      <span class="na">contentType</span><span class="p">:</span> <span class="nx">file</span><span class="p">.</span><span class="kd">type</span><span class="p">,</span>
      <span class="na">byteSize</span><span class="p">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">size</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="nx">url</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">headers</span><span class="p">)</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                Сейчас мы можем реализовать функцию, которая выполнит XHR для
                прямой загрузки:
              </p>
              <div class="language-ts highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">import</span> <span class="p">{</span> <span class="nx">RcCustomRequestOptions</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">antd/lib/upload/interface</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">BlobUpload</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@rails/activestorage/src/blob_upload</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">class</span> <span class="nx">Test</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">customRequest</span><span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">RcCustomRequestOptions</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="nx">headers</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">upload</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BlobUpload</span><span class="p">({</span>
      <span class="nx">file</span><span class="p">,</span>
      <span class="na">directUploadData</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">headers</span><span class="p">:</span> <span class="nx">headers</span> <span class="k">as</span> <span class="nb">Record</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="kr">string</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="nl">url</span><span class="p">:</span> <span class="nx">action</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">upload</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">progress</span><span class="dl">'</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">percent</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">/</span> <span class="nx">event</span><span class="p">.</span><span class="nx">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">onProgress</span><span class="p">({</span> <span class="nx">percent</span> <span class="p">},</span> <span class="nx">file</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">upload</span><span class="p">.</span><span class="nx">create</span><span class="p">((</span><span class="na">error</span><span class="p">:</span> <span class="nb">Error</span><span class="p">,</span> <span class="na">response</span><span class="p">:</span> <span class="nx">object</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">onSuccess</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                Далее, когда у нас есть функции
                <code class="language-plaintext highlighter-rouge"
                  >beforeUpload</code
                >
                и
                <code class="language-plaintext highlighter-rouge"
                  >customRequest</code
                >, мы можем использовать их в хуках компонента Upload:
              </p>
              <div class="language-tsx highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="kd">class</span> <span class="nx">Test</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nc">Upload</span>
        <span class="na">method</span><span class="p">=</span><span class="s">'put'</span> <span class="c1">// important!</span>
        <span class="na">multiple</span><span class="p">=</span><span class="si">{</span><span class="kc">false</span><span class="si">}</span>
        <span class="na">beforeUpload</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">file</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">beforeUpload</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span><span class="si">}</span>
        <span class="na">action</span><span class="p">=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span>
        <span class="na">customRequest</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">options</span><span class="p">):</span> <span class="k">void</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">customRequest</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span><span class="si">}</span>
      <span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nc">Button</span><span class="p">&gt;</span>Click to Upload!<span class="p">&lt;/</span><span class="nc">Button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nc">Upload</span><span class="p">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                Не забудьтье обновить маршруты Rails. Если вы перенаправляете
                все запросы в React:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="n">match</span> <span class="s1">'*path'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'react#index'</span><span class="p">,</span> <span class="ss">via: :all</span>
</code></pre>
                </div>
              </div>

              <p>
                То вы можете исключить маршруты для Active Storage из этого
                правила:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="n">match</span> <span class="s1">'*path'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'react#index'</span><span class="p">,</span> <span class="ss">via: :all</span><span class="p">,</span>
  <span class="ss">constraints: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span> <span class="n">req</span><span class="p">.</span><span class="nf">path</span><span class="p">.</span><span class="nf">exclude?</span> <span class="s1">'rails/active_storage'</span> <span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                Вот и всё. Желаю вам счастливых прямых загрузок
                <img
                  class="emoji"
                  title=":relaxed:"
                  alt=":relaxed:"
                  src="https://github.githubassets.com/images/icons/emoji/unicode/263a.png"
                  height="20"
                  width="20"
                />
              </p>
            </div>
          </article>
        </section>
      </div>

      <footer class="site-footer">
        <div id="footer-contacts">
          <a href="https://t.me/imustafin">Telegram</a>
          <a href="https://github.com/imustafin">GitHub</a>
          <a href="https://www.linkedin.com/in/ilgiz-mustafin-288b99178"
            >LinkedIn</a
          >
        </div>
      </footer>
    </div>
  </body>
</html>
