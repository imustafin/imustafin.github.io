<!DOCTYPE html>

<html lang="tt">
  <head>
    <meta charset="UTF-8" />

    <link
      rel="alternate"
      hreflang="en"
      href="https://imustafin.tatar/blog/optimizing-heroku-postgres-for-free-tier"
    />

    <link
      rel="alternate"
      hreflang="ru"
      href="https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%B1%D0%B4-heroku-postgres-%D0%B4%D0%BB%D1%8F-%D0%B1%D0%B5%D1%81%D0%BF%D0%BB%D0%B0%D1%82%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F"
    />

    <link
      rel="alternate"
      hreflang="tt"
      href="https://imustafin.tatar/tt/%D0%B1%D0%BB%D0%BE%D0%B3/heroku-postgres-%D0%B1%D0%BD-%D0%B1%D1%83%D1%88%D0%BB%D0%B0%D0%B9-%D0%BA%D1%83%D0%BB%D0%BB%D0%B0%D0%BD%D1%83-%D3%A9%D1%87%D0%B5%D0%BD-%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B0%D0%BB%D1%8C%D0%BB%D3%99%D1%88%D1%82%D0%B5%D1%80%D2%AF"
    />

    <link
      rel="alternate"
      type="application/atom+xml"
      href="https://imustafin.tatar/tt/feed.xml"
      title="Татарча язмалар"
    />
    <link
      rel="alternate"
      type="application/atom+xml"
      href="https://imustafin.tatar/feed-multilang.xml"
      title="Posts in all languages"
    />

    <!-- Begin Jekyll SEO tag v2.8.0 -->
    <title>
      Heroku Postgres БН бушлай куллану өчен оптимальләштерү | imustafin.tatar
    </title>
    <meta name="generator" content="Jekyll v4.3.3" />
    <meta
      property="og:title"
      content="Heroku Postgres БН бушлай куллану өчен оптимальләштерү"
    />
    <meta name="author" content="Ильгиз Мустафин" />
    <meta property="og:locale" content="tt" />
    <meta
      name="description"
      content="Реляцион бирелмәләр нигезне (БН) Heroku Postgres бушлай дәрәҗәдә куллану өчен SIBrowser кушымтасы мисалында оптимальләштерү."
    />
    <meta
      property="og:description"
      content="Реляцион бирелмәләр нигезне (БН) Heroku Postgres бушлай дәрәҗәдә куллану өчен SIBrowser кушымтасы мисалында оптимальләштерү."
    />
    <meta
      property="twitter:description"
      content="Реляцион бирелмәләр нигезне (БН) Heroku Postgres бушлай дәрәҗәдә куллану өчен SIBrowser кушымтасы мисалында оптимальләштерү."
    />
    <link
      rel="canonical"
      href="https://imustafin.tatar/tt/%D0%B1%D0%BB%D0%BE%D0%B3/heroku-postgres-%D0%B1%D0%BD-%D0%B1%D1%83%D1%88%D0%BB%D0%B0%D0%B9-%D0%BA%D1%83%D0%BB%D0%BB%D0%B0%D0%BD%D1%83-%D3%A9%D1%87%D0%B5%D0%BD-%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B0%D0%BB%D1%8C%D0%BB%D3%99%D1%88%D1%82%D0%B5%D1%80%D2%AF"
    />
    <meta
      property="og:url"
      content="https://imustafin.tatar/tt/%D0%B1%D0%BB%D0%BE%D0%B3/heroku-postgres-%D0%B1%D0%BD-%D0%B1%D1%83%D1%88%D0%BB%D0%B0%D0%B9-%D0%BA%D1%83%D0%BB%D0%BB%D0%B0%D0%BD%D1%83-%D3%A9%D1%87%D0%B5%D0%BD-%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B0%D0%BB%D1%8C%D0%BB%D3%99%D1%88%D1%82%D0%B5%D1%80%D2%AF"
    />
    <meta property="og:site_name" content="imustafin.tatar" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2021-09-01T00:00:00+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta
      property="twitter:title"
      content="Heroku Postgres БН бушлай куллану өчен оптимальләштерү"
    />
    <!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#157878" />
    <link rel="stylesheet" href="/assets/css/main.css" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />
    <meta name="apple-mobile-web-app-title" content="imustafin.tatar" />
    <meta name="application-name" content="imustafin.tatar" />
    <meta name="msapplication-TileColor" content="#00aba9" />
    <meta name="theme-color" content="#ffffff" />
  </head>
  <body class="text-tcolor" vocab="https://schema.org/" typeof="WebPage">
    <div class="min-h-svh flex flex-col">
      <section
        class="bg-[linear-gradient(120deg,var(--tw-gradient-stops))] from-[#155799] to-ghaze-600 text-white text-center"
      >
        <span class="text-l sm:text-xl font-serif font-semibold mt-2 mb-2 mx-2">
          <a href="/tt/"> Мустафин Ильгизнең шәхси сайты </a>
        </span>

        <div class="flex flex-col lg:flex-row">
          <div class="flex-1"></div>

          <ul class="flex-[2] mb-2 space-x-2">
            <li class="inline"><a href="/tt/">Баш</a></li>

            <li class="inline">
              <a href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/">Блог</a>
            </li>

            <li class="inline">
              <a
                href="/tt/%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%BB%D0%B0%D1%80/"
                >Проектлар</a
              >
            </li>

            <li class="inline">
              <a href="/tt/%D0%B8%D0%BB%D1%8C%D0%B3%D0%B8%D0%B7"
                >Минем турында</a
              >
            </li>
          </ul>

          <ul class="flex-1 space-x-2 mb-2">
            <li class="inline">
              <a lang="en" href="/blog/optimizing-heroku-postgres-for-free-tier"
                >English</a
              >
            </li>

            <li class="inline">
              <a
                lang="ru"
                href="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%B1%D0%B4-heroku-postgres-%D0%B4%D0%BB%D1%8F-%D0%B1%D0%B5%D1%81%D0%BF%D0%BB%D0%B0%D1%82%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F"
                >Русский</a
              >
            </li>

            <li class="inline">
              <a
                lang="tt"
                href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/heroku-postgres-%D0%B1%D0%BD-%D0%B1%D1%83%D1%88%D0%BB%D0%B0%D0%B9-%D0%BA%D1%83%D0%BB%D0%BB%D0%B0%D0%BD%D1%83-%D3%A9%D1%87%D0%B5%D0%BD-%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B0%D0%BB%D1%8C%D0%BB%D3%99%D1%88%D1%82%D0%B5%D1%80%D2%AF"
                >Татарча</a
              >
            </li>
          </ul>
        </div>
      </section>

      <div class="flex-1 p-2 md:pt-4">
        <section class="max-w-prose mx-auto">
          <nav class="mb-4">
            <ol
              property="breadcrumb"
              class="breadcrumbs"
              vocab="https://schema.org/"
              typeof="BreadcrumbList"
            >
              <li
                class="inline-block"
                property="itemListElement"
                typeof="ListItem"
              >
                <a property="item" typeof="WebPage" href="/tt/" class="vlink">
                  <meta
                    property="name"
                    content="Мустафин Ильгиз: программ инженериясендә аспирант"
                  />
                  <span property="alternateName">Баш</span>
                </a>

                <meta property="position" content="1" />
              </li>

              <li
                class="inline-block text-[#afbbc4] before:content-['/']"
                property="itemListElement"
                typeof="ListItem"
              >
                <a
                  property="item"
                  typeof="WebPage"
                  href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/"
                  class="vlink"
                >
                  <span property="name">Блог</span>
                </a>

                <meta property="position" content="2" />
              </li>

              <li
                class="inline-block text-[#afbbc4] before:content-['/']"
                property="itemListElement"
                typeof="ListItem"
              >
                <span
                  property="item"
                  typeof="WebPage"
                  resource="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/heroku-postgres-%D0%B1%D0%BD-%D0%B1%D1%83%D1%88%D0%BB%D0%B0%D0%B9-%D0%BA%D1%83%D0%BB%D0%BB%D0%B0%D0%BD%D1%83-%D3%A9%D1%87%D0%B5%D0%BD-%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B0%D0%BB%D1%8C%D0%BB%D3%99%D1%88%D1%82%D0%B5%D1%80%D2%AF"
                  class="text-tcolor"
                >
                  <span property="name"
                    >Heroku Postgres БН бушлай куллану өчен
                    оптимальләштерү</span
                  >
                </span>

                <meta property="position" content="3" />
              </li>
            </ol>
          </nav>

          <article
            class="max-w-prose"
            itemscope
            itemtype="http://schema.org/BlogPosting"
          >
            <header>
              <div class="prose">
                <h1 itemprop="name headline">
                  Heroku Postgres БН бушлай куллану өчен оптимальләштерү
                </h1>
              </div>
              <div class="italic">
                <time
                  class="inline-block mr-4"
                  datetime="2021-09-01T00:00:00+00:00"
                  itemprop="datePublished"
                >
                  1 сентябрь 2021
                </time>
              </div>
            </header>

            <div itemprop="articleBody" class="prose mt-4">
              <p>
                Реляцион бирелмәләр нигезне (БН) Heroku Postgres бушлай дәрәҗәдә
                куллану өчен SIBrowser кушымтасы мисалында оптимальләштерү.
              </p>

              <p>
                <a href="https://www.sibrowser.ru">SIBrowser</a> —
                <a href="https://vladimirkhil.com/si/game"
                  >Своя игра (SIGame)</a
                >
                пакетлар эзләү сайты. Соңгы вакытта мин бу сайтны ясый идем. Без
                дуслар белән еш уйныйбыз һәм безгә һәрвакыт яхшы пактларны
                эзләргә кирәк. Эзләүне гадиләштерү өчен мин интернеттан пакет
                җыю һәм пакет статистика күрсәтү системаны төзи башладым.
              </p>

              <p>
                Сайт
                <a href="https://rubyonrails.org/">Ruby on Rails</a> нигезендә
                төзелгән һәм
                <a href="https://heroku.com">Heroku</a> платформасында җәелә.
                Акча саклану өчен Heroku-ның бушлай БН дәрәҗәләрне кулланам.
                <a href="https://elements.heroku.com/addons/heroku-postgresql"
                  >Heroku Postgres</a
                >
                бушлай дәрәҗәдә 1ГБ саклагыч урыны һәм 10к БН рәт бирелә.
                <a href="https://elements.heroku.com/addons/heroku-redis"
                  >Heroku Redis</a
                >
                бушлай дәрәҗәдә 25МБ хәтер бирелә.
              </p>

              <p>
                Фонда пакет җыю өчкн мин
                <a href="https://sidekiq.org/">Sidekiq</a>-ны кулланам. Sidekiq
                бирем чиратны Heroku Redis-та саклый. Моның өчен Heroku
                Redis-ның бушлай дәрәҗәсе җитә: хәзер 25МБ-тан &lt; 1МБ
                кулланыла.
              </p>

              <p>
                Ләкин, Heroku Postgres-ның рәт чикләмәләре бу проектта зур
                йогынты ясый.
              </p>

              <h2 id="бирелмәләр-нигезне-акча-саклау-өчен-оптимальләштерү">
                Бирелмәләр нигезне акча саклау өчен оптимальләштерү
              </h2>
              <p>
                Heroku Postgres бушлай дәрәҗәдә куллану өчен, без БН
                архитектурада берничә үзгәреш ясый алабыз. Проектның ER-модельгә
                карыйк:
              </p>

              <p>
                <object
                  data="/uml/15b31463dd82ea6518f3d79110e13a22.svg"
                  type="image/svg+xml"
                  class="plantuml"
                ></object>
              </p>

              <p>
                Ясаучының ноль я күбрәк пакет бар. Пакетның ноль я күбрәк тәг
                һәм раунд бар. Раундның ноль я күбрәк тема бар. Теманың ноль я
                күбрәк сорау бар.
              </p>

              <p>
                Өченче я дүртенче нормаль формага нормальләшкән БН белән эшләргә
                яхшы булыр иде. Ләкин, һәр нормальләштерү адымы рәт саны
                күбәйәчәк.
              </p>

              <p>
                Системада кирәкле БН таләпләргә карап, без кайбер объектларны
                денормальләштерергә алабыз.
              </p>

              <h2 id="адым-1-төп-таблица">Адым 1: төп таблица</h2>
              <p>
                ER-диаграммага караганда,
                <code class="language-plaintext highlighter-rouge">Пакет</code>
                төп объект булуны күрәбез. Чыннан да, башка объектларны
                <code class="language-plaintext highlighter-rouge">Пакет</code
                >-ның атрибутлары кебек сакла алабыз.
              </p>

              <p>
                Тәгләр һәм ясаучылар юл массивы формасында сакла алабыз.
                Раунд-тема-сорау чылбырны <em>структура</em> дип атыйк һәм
                кертелгән массивлар я һәшләр формасында сакла алабыз да.
              </p>

              <p>
                Шундый объект саклау өчен, Active Record-ның
                <a href="serialize">serialize</a> ысулы белән саклаячакбыз.
                Моның өчен БН кырлары
                <code class="language-plaintext highlighter-rouge">text</code>
                яисә
                <code class="language-plaintext highlighter-rouge">string</code>
                типлы булырга тиеш.
              </p>

              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">class</span> <span class="nc">Package</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">serialize</span> <span class="ss">:authors</span><span class="p">,</span> <span class="no">Array</span>
  <span class="n">serialize</span> <span class="ss">:structure</span><span class="p">,</span> <span class="no">Hash</span>
  <span class="n">serialize</span> <span class="ss">:tags</span><span class="p">,</span> <span class="no">Array</span>
<span class="k">end</span>
</code></pre>
                </div>
              </div>

              <p>
                Шулай итеп, барлык ER-модельне бер генә таблицада сакланыла,
                әмма БН нормаль формасыны югалта. Пакетлар гына үзе санлы
                беренчел ачкычы бар.
              </p>

              <p>
                Соңрак без моның бик начар булмавыны күрсәтәчәкбез. БН-дән без
                берничә таләп ясый алабыз әле: барлык пакет исемлекне укый
                алабыз, кирәкле пакетның мәгълүматны ачкыч белән укый алабыз да.
              </p>

              <h2 id="адым-2-jsonb-индекс-белән-ясаучы-буенча-эзләү">
                Адым 2: JSONB индекс белән ясаучы буенча эзләү
              </h2>
              <p>
                Heroku Postgres бушлай дәрәҗәдә индекс саны чикләнмәгән һәм без
                берничә индекс ясачакбыз. Ясаучы буенча эзләү тизләтү өчен,
                <code class="language-plaintext highlighter-rouge">author</code>
                атрибуты нигезендә инвертләнгән индекс төзи алабыз, әмма баштан
                безгә бу атрибутның тибы JSONB-га өйләнергә кирәк.
              </p>

              <p>
                JSONB өйләнүдән соң,
                <code class="language-plaintext highlighter-rouge"
                  >serialize</code
                >
                ысулы безгә кирәкми чөнки кыйммәтләр автоматик рәвештә JSONB-дан
                һәм JSONB-га өйләнәчәкләр.
              </p>

              <p>
                Без хәреф регистр бәйләнмәгән эзләүне ясаячакбыз, чөнки ясаучы
                исемнәре төрле пакетларда төрлечә язылалар.
              </p>

              <p>Баштан индексны төзибез:</p>

              <div class="language-sql highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">authors_icase_index</span>
<span class="k">ON</span> <span class="n">packages</span>
<span class="k">USING</span> <span class="n">gin</span> <span class="p">(</span><span class="k">LOWER</span><span class="p">(</span><span class="n">authors</span><span class="p">::</span><span class="nb">text</span><span class="p">)::</span><span class="n">jsonb</span><span class="p">);</span>
</code></pre>
                </div>
              </div>

              <p>
                Эзләүдә индекс кулланыр өчен, нәкъ шундый таләпне кулланырга
                кирәк:
              </p>

              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">class</span> <span class="nc">Package</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">scope</span> <span class="ss">:by_author</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'LOWER(authors::text)::jsonb @&gt; to_jsonb(LOWER(?)::text)'</span><span class="p">,</span> <span class="n">author</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
                </div>
              </div>

              <p>
                Индекс кулланувын
                <code class="language-plaintext highlighter-rouge">EXPLAIN</code
                >-да күрәбез:
              </p>
              <div class="language-sql highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">EXPLAIN</span> <span class="k">SELECT</span> <span class="nv">"packages"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"packages"</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="k">LOWER</span><span class="p">(</span><span class="n">authors</span><span class="p">::</span><span class="nb">text</span><span class="p">)::</span><span class="n">jsonb</span> <span class="o">@&gt;</span> <span class="n">to_jsonb</span><span class="p">(</span><span class="k">LOWER</span><span class="p">(</span><span class="s1">'Timur'</span><span class="p">)::</span><span class="nb">text</span><span class="p">));</span>

                                    <span class="n">QUERY</span> <span class="n">PLAN</span>                                    
<span class="c1">----------------------------------------------------------------------------------</span>
 <span class="n">Bitmap</span> <span class="n">Heap</span> <span class="n">Scan</span> <span class="k">on</span> <span class="n">packages</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">8</span><span class="p">.</span><span class="mi">08</span><span class="p">..</span><span class="mi">36</span><span class="p">.</span><span class="mi">14</span> <span class="k">rows</span><span class="o">=</span><span class="mi">9</span> <span class="n">width</span><span class="o">=</span><span class="mi">677</span><span class="p">)</span>
   <span class="k">Recheck</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">((</span><span class="k">lower</span><span class="p">((</span><span class="n">authors</span><span class="p">)::</span><span class="nb">text</span><span class="p">))::</span><span class="n">jsonb</span> <span class="o">@&gt;</span> <span class="n">to_jsonb</span><span class="p">(</span><span class="s1">'timur'</span><span class="p">::</span><span class="nb">text</span><span class="p">))</span>
   <span class="o">-&gt;</span>  <span class="n">Bitmap</span> <span class="k">Index</span> <span class="n">Scan</span> <span class="k">on</span> <span class="n">authors_icase_index</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">8</span><span class="p">.</span><span class="mi">07</span> <span class="k">rows</span><span class="o">=</span><span class="mi">9</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">((</span><span class="k">lower</span><span class="p">((</span><span class="n">authors</span><span class="p">)::</span><span class="nb">text</span><span class="p">))::</span><span class="n">jsonb</span> <span class="o">@&gt;</span> <span class="n">to_jsonb</span><span class="p">(</span><span class="s1">'timur'</span><span class="p">::</span><span class="nb">text</span><span class="p">))</span>
</code></pre>
                </div>
              </div>

              <p>
                Ләкин, ясаучының санлы беренчел ачкычы юк. Ясаучыларны аларның
                аскы регистрлы исемләре нигезендә аңлыйбыз. Бу очракта,
                ясаучының исеме адрес эчендә булырга тиеш:
              </p>

              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="c1"># routes.rb</span>
<span class="n">resources</span> <span class="ss">:authors</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">],</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">id: </span><span class="sr">/.+/</span> <span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                Шундый
                <code class="language-plaintext highlighter-rouge"
                  >constraints</code
                >
                көйләве Rails-ка буш аралы һәм авыш сызыклы исемнәрне аңларга
                әйтә. Мәсәлән, системада
                <code class="language-plaintext highlighter-rouge"
                  >https://vk.com/sigamepack</code
                >
                исемле ясаучы бар һәм аның бите
                <a
                  href="https://www.sibrowser.ru/authors/https:%2F%2Fvk.com%2Fsigamepack"
                  >https://www.sibrowser.ru/authors/https://vk.com/sigamepack</a
                >
                адреста урнашкан.
              </p>

              <h2 id="адым-3-jsonb-атрибут-бунча-тулы-текст-эзләү">
                Адым 3: JSONB атрибут бунча тулы текст эзләү
              </h2>
              <p>JSONB атрбутларда тулы текст эзләүне ясый алабыз да.</p>

              <p>
                <a
                  href="https://pganalyze.com/blog/full-text-search-ruby-rails-postgres"
                  >Ли Һаллидейнның мәкәләсе</a
                >
                тулы текст эзләүне
                <a href="https://rubygems.org/gems/pg_search">pg_search</a> гемы
                һәм
                <code class="language-plaintext highlighter-rouge"
                  >ts_vector</code
                >
                тибы нигезендә төзүне тасвирлый.
              </p>

              <p>
                Монда мин JSONB атрибут өчендә эзләү өчен охшаш ысулы күрсәтәм.
              </p>

              <p>
                Исәпләнүче
                <code class="language-plaintext highlighter-rouge"
                  >searchable</code
                >
                баганасы JSONB элементларга үзе дәрәҗәләрне бирә ала.
                <code class="language-plaintext highlighter-rouge"
                  >to_tsvector</code
                >
                функциясе икенче аргумент урында JSONB типны да аңлый.
              </p>

              <div class="language-sql highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">packages</span>
<span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">searchable</span> <span class="n">tsvector</span> <span class="k">GENERATED</span> <span class="n">ALWAYS</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">'russian'</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">''</span><span class="p">)),</span> <span class="s1">'A'</span><span class="p">)</span> <span class="o">||</span>
  <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">'russian'</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">authors</span><span class="p">,</span> <span class="s1">'{}'</span><span class="p">)),</span> <span class="s1">'B'</span><span class="p">)</span> <span class="o">||</span>
  <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">'russian'</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="s1">'{}'</span><span class="p">)),</span> <span class="s1">'B'</span><span class="p">)</span> <span class="o">||</span>
  <span class="c1">-- Раунд исемләре</span>
  <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">'russian'</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">jsonb_path_query_array</span><span class="p">(</span><span class="k">structure</span><span class="p">,</span> <span class="s1">'$[*].name'</span><span class="p">),</span> <span class="s1">'{}'</span><span class="p">)),</span> <span class="s1">'B'</span><span class="p">)</span> <span class="o">||</span>
  <span class="c1">-- Тема исемләре</span>
  <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">'russian'</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">jsonb_path_query_array</span><span class="p">(</span><span class="k">structure</span><span class="p">,</span> <span class="s1">'$[*].themes[*].name'</span><span class="p">),</span> <span class="s1">'{}'</span><span class="p">)),</span> <span class="s1">'B'</span><span class="p">)</span>
<span class="p">)</span> <span class="n">STORED</span><span class="p">;</span>
</code></pre>
                </div>
              </div>

              <p>
                Бу үрнәктә JSONB-да ерак кертелгән кыйммәтне, JSON юллары
                кулланып, индекска кую күрсәтелгән.
              </p>

              <p>
                <code class="language-plaintext highlighter-rouge"
                  >pg_search</code
                >
                көйләве шундый ук кала:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">class</span> <span class="nc">Package</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">PgSearch</span><span class="o">::</span><span class="no">Model</span>
  
  <span class="n">pg_search_scope</span> <span class="ss">:search_freetext</span><span class="p">,</span>
    <span class="ss">against: :searchable</span><span class="p">,</span> <span class="c1"># tsvector_column булганда куллынмый</span>
    <span class="ss">using: </span><span class="p">{</span>
      <span class="ss">tsearch: </span><span class="p">{</span>
        <span class="ss">dictionary: </span><span class="s1">'russian'</span><span class="p">,</span>
        <span class="ss">tsvector_column: </span><span class="s1">'searchable'</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="k">end</span>
</code></pre>
                </div>
              </div>

              <h2 id="йомгаклау">Йомгаклау</h2>
              <p>Бу мәкаләдә без берничә мәсьәлә карап чыктык:</p>
              <ul>
                <li>
                  Heroku Postgres бушлай дәрәҗәнең чикләмәләр һәм алар белән
                  эшләү
                </li>
                <li>JSONB белән БН денормальләштерү</li>
                <li>JSONB өчен инвертләштереләгән индекс төзү</li>
                <li>JSONB объектларга кертелгән юлларда тулы текст эзләү</li>
              </ul>
            </div>
          </article>
        </section>
      </div>

      <footer
        class="bg-[linear-gradient(120deg,var(--tw-gradient-stops))] from-[#155799] to-ghaze-600 text-white mt-4 pt-4 pb-4"
      >
        <ul class="space-x-4 flex justify-center">
          <li class="inline">
            <a lang="en" href="/blog/optimizing-heroku-postgres-for-free-tier"
              >English</a
            >
          </li>

          <li class="inline">
            <a
              lang="ru"
              href="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%B1%D0%B4-heroku-postgres-%D0%B4%D0%BB%D1%8F-%D0%B1%D0%B5%D1%81%D0%BF%D0%BB%D0%B0%D1%82%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F"
              >Русский</a
            >
          </li>

          <li class="inline">
            <a
              lang="tt"
              href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/heroku-postgres-%D0%B1%D0%BD-%D0%B1%D1%83%D1%88%D0%BB%D0%B0%D0%B9-%D0%BA%D1%83%D0%BB%D0%BB%D0%B0%D0%BD%D1%83-%D3%A9%D1%87%D0%B5%D0%BD-%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B0%D0%BB%D1%8C%D0%BB%D3%99%D1%88%D1%82%D0%B5%D1%80%D2%AF"
              >Татарча</a
            >
          </li>
        </ul>
      </footer>
    </div>
  </body>
</html>
