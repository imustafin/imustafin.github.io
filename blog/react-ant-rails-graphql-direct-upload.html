<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <link
      rel="alternate"
      hreflang="en"
      href="https://imustafin.tatar/blog/react-ant-rails-graphql-direct-upload"
    />

    <link
      rel="alternate"
      hreflang="ru"
      href="https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
    />

    <link
      rel="alternate"
      hreflang="tt"
      href="https://imustafin.tatar/tt/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-graphql-rails-%D1%82%D1%83%D1%80%D1%8B-%D0%B9%D3%A9%D0%BA%D0%BB%D3%99%D2%AF"
    />

    <link
      rel="alternate"
      type="application/atom+xml"
      href="https://imustafin.tatar/feed.xml"
      title="Posts in English"
    />
    <link
      rel="alternate"
      type="application/atom+xml"
      href="https://imustafin.tatar/feed-multilang.xml"
      title="Posts in all languages"
    />

    <!-- Begin Jekyll SEO tag v2.8.0 -->
    <title>
      Rails React Ant Direct File Upload with GraphQL | imustafin.tatar
    </title>
    <meta name="generator" content="Jekyll v4.3.3" />
    <meta
      property="og:title"
      content="Rails React Ant Direct File Upload with GraphQL"
    />
    <meta name="author" content="Ilgiz Mustafin" />
    <meta property="og:locale" content="en" />
    <meta
      name="description"
      content="An implementation of direct file uploads to Ruby on Rails Active Storage from a React TypeScript application using Ant Design with a GraphQL API."
    />
    <meta
      property="og:description"
      content="An implementation of direct file uploads to Ruby on Rails Active Storage from a React TypeScript application using Ant Design with a GraphQL API."
    />
    <meta
      property="twitter:description"
      content="An implementation of direct file uploads to Ruby on Rails Active Storage from a React TypeScript application using Ant Design with a GraphQL API."
    />
    <link
      rel="canonical"
      href="https://imustafin.tatar/blog/react-ant-rails-graphql-direct-upload"
    />
    <meta
      property="og:url"
      content="https://imustafin.tatar/blog/react-ant-rails-graphql-direct-upload"
    />
    <meta property="og:site_name" content="imustafin.tatar" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2020-11-09T00:00:00+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta
      property="twitter:title"
      content="Rails React Ant Direct File Upload with GraphQL"
    />
    <!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#157878" />
    <link rel="stylesheet" href="/assets/css/main.css" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />
    <meta name="apple-mobile-web-app-title" content="imustafin.tatar" />
    <meta name="application-name" content="imustafin.tatar" />
    <meta name="msapplication-TileColor" content="#00aba9" />
    <meta name="theme-color" content="#ffffff" />
  </head>
  <body class="text-tcolor" vocab="https://schema.org/" typeof="WebPage">
    <div class="min-h-svh flex flex-col">
      <section
        class="bg-[linear-gradient(120deg,var(--tw-gradient-stops))] from-[#155799] to-ghaze-600 text-white text-center"
      >
        <span class="text-l sm:text-xl font-serif font-semibold mt-2 mb-2 mx-2">
          <a href="/"> Ilgiz Mustafin's personal website </a>
        </span>

        <div class="flex flex-col lg:flex-row">
          <div class="flex-1"></div>

          <ul class="flex-[2] mb-2 space-x-2">
            <li class="inline"><a href="/">Home</a></li>

            <li class="inline"><a href="/blog/">Blog</a></li>

            <li class="inline"><a href="/projects/">Projects</a></li>

            <li class="inline"><a href="/ilgiz">About</a></li>
          </ul>

          <ul class="flex-1 space-x-2 mb-2">
            <li class="inline">
              <a lang="en" href="/blog/react-ant-rails-graphql-direct-upload"
                >English</a
              >
            </li>

            <li class="inline">
              <a
                lang="ru"
                href="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
                >Русский</a
              >
            </li>

            <li class="inline">
              <a
                lang="tt"
                href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-graphql-rails-%D1%82%D1%83%D1%80%D1%8B-%D0%B9%D3%A9%D0%BA%D0%BB%D3%99%D2%AF"
                >Татарча</a
              >
            </li>
          </ul>
        </div>
      </section>

      <div class="flex-1 p-2 md:pt-4">
        <section class="max-w-prose mx-auto">
          <nav class="mb-4">
            <ol
              property="breadcrumb"
              class="breadcrumbs"
              vocab="https://schema.org/"
              typeof="BreadcrumbList"
            >
              <li
                class="inline-block"
                property="itemListElement"
                typeof="ListItem"
              >
                <a property="item" typeof="WebPage" href="/" class="vlink">
                  <meta
                    property="name"
                    content="Ilgiz Mustafin: PhD Student in Software Engineering"
                  />
                  <span property="alternateName">Main</span>
                </a>

                <meta property="position" content="1" />
              </li>

              <li
                class="inline-block text-[#afbbc4] before:content-['/']"
                property="itemListElement"
                typeof="ListItem"
              >
                <a property="item" typeof="WebPage" href="/blog/" class="vlink">
                  <span property="name">Blog</span>
                </a>

                <meta property="position" content="2" />
              </li>

              <li
                class="inline-block text-[#afbbc4] before:content-['/']"
                property="itemListElement"
                typeof="ListItem"
              >
                <span
                  property="item"
                  typeof="WebPage"
                  resource="/blog/react-ant-rails-graphql-direct-upload"
                  class="text-tcolor"
                >
                  <span property="name"
                    >Rails React Ant Direct File Upload with GraphQL</span
                  >
                </span>

                <meta property="position" content="3" />
              </li>
            </ol>
          </nav>

          <article
            class="max-w-prose"
            itemscope
            itemtype="http://schema.org/BlogPosting"
          >
            <header>
              <div class="prose">
                <h1 itemprop="name headline">
                  Rails React Ant Direct File Upload with GraphQL
                </h1>
              </div>
              <div class="italic">
                <time
                  class="inline-block mr-4"
                  datetime="2020-11-09T00:00:00+00:00"
                  itemprop="datePublished"
                >
                  9 November 2020
                </time>

                <span class="inline-block">
                  Last modified:
                  <time
                    datetime="2020-12-03T00:00:00+00:00"
                    itemprop="dateModified"
                  >
                    3 December 2020
                  </time>
                </span>
              </div>
            </header>

            <div itemprop="articleBody" class="prose mt-4">
              <p>
                An implementation of direct file uploads to Ruby on Rails Active
                Storage from a React TypeScript application using Ant Design
                with a GraphQL API.
              </p>

              <h2 id="problem">Problem</h2>
              <p>
                On one hand, Ant Design provides a nice Upload component for
                choosing and uploading files. Usually it is very is easy to use,
                just provide the upload URL and Ant will make a POST request
                with the file attached.
              </p>

              <div class="language-jsx highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Upload</span><span class="p">,</span> <span class="nx">Button</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">antd</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">Test</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">Upload</span>
    <span class="na">name</span><span class="p">=</span><span class="s">'avatar'</span>
    <span class="na">action</span><span class="p">=</span><span class="s">'https://example.com/avatar'</span>
  <span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nc">Button</span><span class="p">&gt;</span>Click to Upload<span class="p">&lt;/</span><span class="nc">Button</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nc">Upload</span><span class="p">&gt;</span>
<span class="p">);</span>
</code></pre>
                </div>
              </div>

              <p>
                On the other hand, Ruby on Rails (Rails) suggests adding the
                file field in a Rails view and handling the form submission with
                a Rails controller which will automatically handle the uploaded
                file.
              </p>
              <div class="language-erb highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">file_field</span> <span class="ss">:avatar</span> <span class="cp">%&gt;</span>
</code></pre>
                </div>
              </div>

              <p>
                We were not using Rails views in this project before and the
                layout was rendered only by React, because of this we needed
                some other way to upload files.
              </p>

              <h2 id="solution">Solution</h2>
              <p>
                The solution is based on articles
                <a
                  href="https://evilmartians.com/chronicles/active-storage-meets-graphql-direct-uploads"
                  >Active Storage meets GraphQL: Direct Uploads</a
                >,
                <a
                  href="https://cameronbothner.com/activestorage-beyond-rails-views/"
                  >How to Use ActiveStorage Outside of a Rails View</a
                >
                and
                <a
                  href="https://cameronbothner.com/activestorage-beyond-rails-views/"
                  >this StackOverflow answer</a
                >.
              </p>

              <p>An Active Storage direct upload happens in several steps:</p>
              <ol>
                <li>Client extracts the file’s metadata</li>
                <li>Client sends the metadata to the Server</li>
                <li>Server prepares an upload with the Service</li>
                <li>
                  Server sends the upload url and required headers to the Client
                </li>
                <li>
                  Client uploads the file to the Service using url and headers
                  from the Server
                </li>
              </ol>

              <p>
                In this example we are using a GraphQL API, so steps 2, 3, 4
                will be implemented as a GraphQL mutation.
              </p>

              <h3 id="server-side">Server-side</h3>

              <p>
                The parameters of the direct upload depend on these metadata of
                the file:
              </p>
              <ul>
                <li>File name</li>
                <li>Content type</li>
                <li>
                  Checksum (more on this <a href="#client-side">below</a>)
                </li>
                <li>File size</li>
              </ul>

              <p>
                We will use a GraphQL mutation to pass these values to backend.
                The results of the mutation will include the options needed for
                an upload.
              </p>

              <p>
                We will pass these values to the mutation and result of the
                mutation will have the values required for an upload (URL and
                headers) as well as the blob ids.
              </p>

              <p>
                We are using the
                <a href="https://graphql-ruby.org/"
                  ><code class="language-plaintext highlighter-rouge"
                    >graphql</code
                  >
                  gem</a
                >
                as our implementation of the GraphQL controller in Rails.
              </p>

              <p>
                As we said before, we will have a mutation which takes the
                file’s meta information and gives the data required for an
                upload:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">module</span> <span class="nn">Mutations</span>
  <span class="k">class</span> <span class="nc">CreateDirectUpload</span> <span class="o">&lt;</span> <span class="no">BaseMutation</span>
    <span class="n">argument</span> <span class="ss">:filename</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>
    <span class="n">argument</span> <span class="ss">:byte_size</span><span class="p">,</span> <span class="no">Int</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>
    <span class="n">argument</span> <span class="ss">:checksum</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>
    <span class="n">argument</span> <span class="ss">:content_type</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>

    <span class="n">field</span> <span class="ss">:url</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="n">field</span> <span class="ss">:headers</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="s1">'JSON of required HTTP headers'</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="n">field</span> <span class="ss">:blob_id</span><span class="p">,</span> <span class="no">ID</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="n">field</span> <span class="ss">:signed_blob_id</span><span class="p">,</span> <span class="no">ID</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
                </div>
              </div>

              <p>
                The
                <code class="language-plaintext highlighter-rouge"
                  >resolve</code
                >
                method will create the blob and return the parameters needed for
                the upload:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">module</span> <span class="nn">Mutations</span>
  <span class="k">class</span> <span class="nc">CreateDirectUpload</span> <span class="o">&lt;</span> <span class="no">BaseMutation</span>
    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">filename</span><span class="p">:,</span> <span class="n">byte_size</span><span class="p">:,</span> <span class="n">checksum</span><span class="p">:,</span> <span class="n">content_type</span><span class="p">:)</span>
      <span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_before_direct_upload!</span><span class="p">(</span>
        <span class="ss">filename: </span><span class="n">filename</span><span class="p">,</span>
        <span class="ss">byte_size: </span><span class="n">byte_size</span><span class="p">,</span>
        <span class="ss">checksum: </span><span class="n">checksum</span><span class="p">,</span>
        <span class="ss">content_type: </span><span class="n">content_type</span>
      <span class="p">)</span>

      <span class="p">{</span>
        <span class="ss">url: </span><span class="n">blob</span><span class="p">.</span><span class="nf">service_url_for_direct_upload</span><span class="p">,</span>
        <span class="ss">headers: </span><span class="n">blob</span><span class="p">.</span><span class="nf">service_headers_for_direct_upload</span><span class="p">.</span><span class="nf">to_json</span><span class="p">,</span>
        <span class="ss">blob_id: </span><span class="n">blob</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
        <span class="ss">signed_blob_id: </span><span class="n">blob</span><span class="p">.</span><span class="nf">signed_id</span>
      <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
                </div>
              </div>

              <p>
                Now the client can use this mutation to prepare a direct upload.
              </p>

              <h3 id="client-side">Client-side</h3>
              <p>
                Mutation’s arguments are self-explanatory except the the
                <code class="language-plaintext highlighter-rouge"
                  >checksum</code
                >
                argument. The checksum string should be computed with a specific
                algorithm which is provided in the
                <a href="https://www.npmjs.com/package/@rails/activestorage"
                  ><code class="language-plaintext highlighter-rouge"
                    >@rails/activestorage</code
                  >
                  package</a
                >.
              </p>

              <p>
                <strong>Bonus!</strong> TypeScript typings are available with
                the
                <a
                  href="https://www.npmjs.com/package/@types/rails__activestorage"
                  ><code class="language-plaintext highlighter-rouge"
                    >@types/rails__activestorage</code
                  >
                  package</a
                >.
              </p>

              <div class="language-ts highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">import</span> <span class="p">{</span> <span class="nx">FileChecksum</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@rails/activestorage/src/file_checksum</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">calculateChecksum</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">:</span> <span class="nx">File</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">(</span>
  <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="nx">FileChecksum</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">checksum</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nf">resolve</span><span class="p">(</span><span class="nx">checksum</span><span class="p">);</span>
    <span class="p">})</span>
  <span class="p">))</span>
<span class="p">);</span>
</code></pre>
                </div>
              </div>

              <p>
                Ant Upload takes a
                <code class="language-plaintext highlighter-rouge"
                  >beforeUpload</code
                >
                function which we will use to get the upload parameters. In this
                example we will assume that a single file is uploaded. As an
                example, we will store the results of the mutation in the state
                and use it later.
              </p>

              <div class="language-ts highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">import</span> <span class="p">{</span> <span class="nx">RcFile</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">antd/lib/upload</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Test</span> <span class="kd">extends</span> <span class="nc">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="k">async</span> <span class="nf">beforeUpload</span><span class="p">(</span><span class="nx">file</span><span class="p">:</span> <span class="nx">RcFile</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// createDirectUploadMutation is a placeholder for your GraphQL request method</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">headers</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">createDirectUploadMutation</span><span class="p">({</span>
      <span class="na">checksum</span><span class="p">:</span> <span class="k">await</span> <span class="nf">calculateChecksum</span><span class="p">(</span><span class="nx">file</span><span class="p">),</span>
      <span class="na">filename</span><span class="p">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span>
      <span class="na">contentType</span><span class="p">:</span> <span class="nx">file</span><span class="p">.</span><span class="kd">type</span><span class="p">,</span>
      <span class="na">byteSize</span><span class="p">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">size</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nf">setState</span><span class="p">({</span> <span class="nx">url</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">headers</span><span class="p">)</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                Now we are ready to implement a function which will do the
                direct upload XHR:
              </p>
              <div class="language-ts highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">import</span> <span class="p">{</span> <span class="nx">RcCustomRequestOptions</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">antd/lib/upload/interface</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">BlobUpload</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@rails/activestorage/src/blob_upload</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Test</span> <span class="kd">extends</span> <span class="nc">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nf">customRequest</span><span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">RcCustomRequestOptions</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="nx">headers</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">upload</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlobUpload</span><span class="p">({</span>
      <span class="nx">file</span><span class="p">,</span>
      <span class="na">directUploadData</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">headers</span><span class="p">:</span> <span class="nx">headers</span> <span class="kd">as </span><span class="nb">Record</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="kr">string</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="nl">url</span><span class="p">:</span> <span class="nx">action</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">upload</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">progress</span><span class="dl">'</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">percent</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">/</span> <span class="nx">event</span><span class="p">.</span><span class="nx">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nf">onProgress</span><span class="p">({</span> <span class="nx">percent</span> <span class="p">},</span> <span class="nx">file</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">upload</span><span class="p">.</span><span class="nf">create</span><span class="p">((</span><span class="na">error</span><span class="p">:</span> <span class="nb">Error</span><span class="p">,</span> <span class="na">response</span><span class="p">:</span> <span class="nx">object</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nf">onError</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nf">onSuccess</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                With
                <code class="language-plaintext highlighter-rouge"
                  >beforeUpload</code
                >
                and
                <code class="language-plaintext highlighter-rouge"
                  >customRequest</code
                >
                defined, we can use them in Upload’s hooks:
              </p>
              <div class="language-tsx highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="kd">class</span> <span class="nc">Test</span> <span class="kd">extends</span> <span class="nc">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nf">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return </span><span class="p">(</span>
      <span class="p">&lt;</span><span class="nc">Upload</span>
        <span class="na">method</span><span class="p">=</span><span class="s">'put'</span> <span class="c1">// important!</span>
        <span class="na">multiple</span><span class="p">=</span><span class="si">{</span><span class="kc">false</span><span class="si">}</span>
        <span class="na">beforeUpload</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">file</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nf">beforeUpload</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span><span class="si">}</span>
        <span class="na">action</span><span class="p">=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span>
        <span class="na">customRequest</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">options</span><span class="p">):</span> <span class="k">void</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nf">customRequest</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span><span class="si">}</span>
      <span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nc">Button</span><span class="p">&gt;</span>Click to Upload!<span class="p">&lt;/</span><span class="nc">Button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nc">Upload</span><span class="p">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                Don’t forget to update the Rails routes. If you have a wildcard
                rule to redirect all requests to React like this:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="n">match</span> <span class="s1">'*path'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'react#index'</span><span class="p">,</span> <span class="ss">via: :all</span>
</code></pre>
                </div>
              </div>

              <p>
                Then you can exclude the Active Storage paths from this rule
                like this:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="n">match</span> <span class="s1">'*path'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'react#index'</span><span class="p">,</span> <span class="ss">via: :all</span><span class="p">,</span>
  <span class="ss">constraints: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span> <span class="n">req</span><span class="p">.</span><span class="nf">path</span><span class="p">.</span><span class="nf">exclude?</span> <span class="s1">'rails/active_storage'</span> <span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>And that’s it. Happy direct uploading!</p>
            </div>
          </article>
        </section>
      </div>

      <footer
        class="bg-[linear-gradient(120deg,var(--tw-gradient-stops))] from-[#155799] to-ghaze-600 text-white mt-4 pt-4 pb-4"
      >
        <ul class="space-x-4 flex justify-center">
          <li class="inline">
            <a lang="en" href="/blog/react-ant-rails-graphql-direct-upload"
              >English</a
            >
          </li>

          <li class="inline">
            <a
              lang="ru"
              href="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
              >Русский</a
            >
          </li>

          <li class="inline">
            <a
              lang="tt"
              href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-graphql-rails-%D1%82%D1%83%D1%80%D1%8B-%D0%B9%D3%A9%D0%BA%D0%BB%D3%99%D2%AF"
              >Татарча</a
            >
          </li>
        </ul>
      </footer>
    </div>
  </body>
</html>
