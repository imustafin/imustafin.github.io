<!DOCTYPE html>

<html lang="tt">
  <head>
    <meta charset="UTF-8" />

    <link
      rel="alternate"
      hreflang="en"
      href="https://imustafin.tatar/blog/react-ant-rails-graphql-direct-upload"
    />

    <link
      rel="alternate"
      hreflang="ru"
      href="https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
    />

    <link
      rel="alternate"
      hreflang="tt"
      href="https://imustafin.tatar/tt/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-graphql-rails-%D1%82%D1%83%D1%80%D1%8B-%D0%B9%D3%A9%D0%BA%D0%BB%D3%99%D2%AF"
    />

    <!-- Begin Jekyll SEO tag v2.8.0 -->
    <title>
      Rails React Ant-та GraphQL аша туры файл йөкләү | imustafin.tatar
    </title>
    <meta name="generator" content="Jekyll v4.3.3" />
    <meta
      property="og:title"
      content="Rails React Ant-та GraphQL аша туры файл йөкләү"
    />
    <meta name="author" content="Ильгиз Мустафин" />
    <meta property="og:locale" content="tt" />
    <meta
      name="description"
      content="Ruby on Rails һәм Active Storage серверга React TypeScript кушымтадан Ant Design һәм GraphQL API кулланып туры файл йөкләү ясавы."
    />
    <meta
      property="og:description"
      content="Ruby on Rails һәм Active Storage серверга React TypeScript кушымтадан Ant Design һәм GraphQL API кулланып туры файл йөкләү ясавы."
    />
    <meta
      property="twitter:description"
      content="Ruby on Rails һәм Active Storage серверга React TypeScript кушымтадан Ant Design һәм GraphQL API кулланып туры файл йөкләү ясавы."
    />
    <link
      rel="canonical"
      href="https://imustafin.tatar/tt/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-graphql-rails-%D1%82%D1%83%D1%80%D1%8B-%D0%B9%D3%A9%D0%BA%D0%BB%D3%99%D2%AF"
    />
    <meta
      property="og:url"
      content="https://imustafin.tatar/tt/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-graphql-rails-%D1%82%D1%83%D1%80%D1%8B-%D0%B9%D3%A9%D0%BA%D0%BB%D3%99%D2%AF"
    />
    <meta property="og:site_name" content="imustafin.tatar" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2020-11-15T00:00:00+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta
      property="twitter:title"
      content="Rails React Ant-та GraphQL аша туры файл йөкләү"
    />
    <!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#157878" />
    <link rel="stylesheet" href="/assets/css/main.css" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />
    <meta name="apple-mobile-web-app-title" content="imustafin.tatar" />
    <meta name="application-name" content="imustafin.tatar" />
    <meta name="msapplication-TileColor" content="#00aba9" />
    <meta name="theme-color" content="#ffffff" />
  </head>
  <body class="text-tcolor" vocab="https://schema.org/" typeof="WebPage">
    <div class="min-h-svh flex flex-col">
      <section
        class="bg-[linear-gradient(120deg,var(--tw-gradient-stops))] from-[#155799] to-ghaze-600 text-white text-center"
      >
        <span class="text-l sm:text-xl font-serif font-semibold mt-2 mb-2 mx-2">
          <a href="/tt/"> Мустафин Ильгизнең шәхси сайты </a>
        </span>

        <div class="flex flex-col lg:flex-row">
          <div class="flex-1"></div>

          <ul class="flex-[2] mb-2 space-x-2">
            <li class="inline"><a href="/tt/">Баш</a></li>

            <li class="inline">
              <a href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/">Блог</a>
            </li>

            <li class="inline">
              <a
                href="/tt/%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%BB%D0%B0%D1%80/"
                >Проектлар</a
              >
            </li>

            <li class="inline">
              <a href="/tt/%D0%B8%D0%BB%D1%8C%D0%B3%D0%B8%D0%B7"
                >Минем турында</a
              >
            </li>
          </ul>

          <ul class="flex-1 space-x-2 mb-2">
            <li class="inline">
              <a lang="en" href="/blog/react-ant-rails-graphql-direct-upload"
                >English</a
              >
            </li>

            <li class="inline">
              <a
                lang="ru"
                href="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
                >Русский</a
              >
            </li>

            <li class="inline">
              <a
                lang="tt"
                href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-graphql-rails-%D1%82%D1%83%D1%80%D1%8B-%D0%B9%D3%A9%D0%BA%D0%BB%D3%99%D2%AF"
                >Татарча</a
              >
            </li>
          </ul>
        </div>
      </section>

      <div class="flex-1 p-2 md:pt-4">
        <section class="max-w-prose mx-auto">
          <nav class="mb-4">
            <ol
              property="breadcrumb"
              class="breadcrumbs"
              vocab="https://schema.org/"
              typeof="BreadcrumbList"
            >
              <li
                class="inline-block"
                property="itemListElement"
                typeof="ListItem"
              >
                <a
                  property="item"
                  typeof="WebPage"
                  href="/tt/"
                  class="text-clink hover:underline"
                >
                  <meta
                    property="name"
                    content="Мустафин Ильгиз: программ инженериясендә аспирант"
                  />
                  <span property="alternateName">Баш</span>
                </a>

                <meta property="position" content="1" />
              </li>

              <li
                class="inline-block text-[#afbbc4] before:content-['/']"
                property="itemListElement"
                typeof="ListItem"
              >
                <a
                  property="item"
                  typeof="WebPage"
                  href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/"
                  class="text-clink hover:underline"
                >
                  <span property="name">Блог</span>
                </a>

                <meta property="position" content="2" />
              </li>

              <li
                class="inline-block text-[#afbbc4] before:content-['/']"
                property="itemListElement"
                typeof="ListItem"
              >
                <span
                  property="item"
                  typeof="WebPage"
                  resource="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-graphql-rails-%D1%82%D1%83%D1%80%D1%8B-%D0%B9%D3%A9%D0%BA%D0%BB%D3%99%D2%AF"
                  class="text-tcolor"
                >
                  <span property="name"
                    >Rails React Ant-та GraphQL аша туры файл йөкләү</span
                  >
                </span>

                <meta property="position" content="3" />
              </li>
            </ol>
          </nav>

          <article
            class="max-w-prose"
            itemscope
            itemtype="http://schema.org/BlogPosting"
          >
            <header>
              <div class="prose">
                <h1 itemprop="name headline">
                  Rails React Ant-та GraphQL аша туры файл йөкләү
                </h1>
              </div>
              <div class="italic">
                <time
                  class="inline-block mr-4"
                  datetime="2020-11-15T00:00:00+00:00"
                  itemprop="datePublished"
                >
                  15 ноябрь 2020
                </time>

                <span class="inline-block">
                  Соңгы үзгәреш:
                  <time
                    datetime="2021-01-25T00:00:00+00:00"
                    itemprop="dateModified"
                  >
                    25 гыйнвар 2021
                  </time>
                </span>
              </div>
            </header>

            <div itemprop="articleBody" class="prose mt-4">
              <p>
                Ruby on Rails һәм Active Storage серверга React TypeScript
                кушымтадан Ant Design һәм GraphQL API кулланып туры файл йөкләү
                ясавы.
              </p>

              <h2 id="проблема">Проблема</h2>
              <p>
                Бер яктан, Ant Design библиотекасының Upload компоненты файл
                сайлау һәм серверга йөкләү өчен кулланыла ала. Гадәттә, бу
                компонентны куллану бик җиңел: компонентка йөкләү URL-ны
                бирсәгез, Ant үзе файл кушып POST таләбе ясаячак.
              </p>

              <div class="language-jsx highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Upload</span><span class="p">,</span> <span class="nx">Button</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">antd</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">Test</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">Upload</span>
    <span class="na">name</span><span class="p">=</span><span class="s">'avatar'</span>
    <span class="na">action</span><span class="p">=</span><span class="s">'https://example.com/avatar'</span>
  <span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nc">Button</span><span class="p">&gt;</span>Click to Upload<span class="p">&lt;/</span><span class="nc">Button</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nc">Upload</span><span class="p">&gt;</span>
<span class="p">);</span>
</code></pre>
                </div>
              </div>

              <p>
                Икенче яктан, Rails файл йөкләү кырыны күрсәтелештә ясарга
                тәкъдим итә:
              </p>
              <div class="language-erb highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">file_field</span> <span class="ss">:avatar</span><span class="p">,</span> <span class="ss">direct_upload: </span><span class="kp">true</span> <span class="cp">%&gt;</span>
</code></pre>
                </div>
              </div>

              <p>
                Проектыбызда без Rails күрсәтелешләрне кулланмадык һәм бөтен
                разметканы React-та гына ясадык. Шуңа күрә, безгә башка файл
                йөкләү ысулы кирәк.
              </p>

              <h2 id="чишелеш">Чишелеш</h2>
              <p>
                Чишелешебез
                <a
                  href="https://evilmartians.com/chronicles/active-storage-meets-graphql-direct-uploads"
                  >Active Storage meets GraphQL: Direct Uploads</a
                >,
                <a
                  href="https://cameronbothner.com/activestorage-beyond-rails-views/"
                  >How to Use ActiveStorage Outside of a Rails View</a
                >
                мәкаләләргә һәм
                <a
                  href="https://cameronbothner.com/activestorage-beyond-rails-views/"
                  >бу StackOverflow җавапка</a
                >
                нигезләнә.
              </p>

              <p>Active Storage-ның туры файл йөкләү берничә адымдан тора:</p>
              <ol>
                <li>Клиент файлдан метамәгълүматны ала</li>
                <li>Клиент метамәгълүматны серверга җибәрә</li>
                <li>Сервер Сервис белән файл йөкләүне әзерли</li>
                <li>
                  Сервер Клиентка йөкләү URL-ны һәм кирәкле башламаларны җибәрә
                </li>
                <li>
                  Клиент йөкләү URL-ны һәм башламаларны кулланып Сервиска файлны
                  йөкли
                </li>
              </ol>

              <p>
                Бу үрнәктә без GraphQL-ны кулланабыз, шуңа күрә адымнар 2, 3, 4
                GraphQL мутацияне кулланачаклар.
              </p>

              <h3 id="сервер-ягы">Сервер ягы</h3>
              <p>Йөкләү көйләүләре файл метамагълүматларга бәйле:</p>
              <ul>
                <li>Файл исеме</li>
                <li>Мәгълүмат тибы</li>
                <li>
                  Контроль суммасы (моның турында
                  <a href="#клиент-ягы">түбәндә карагыз</a>)
                </li>
                <li>Файл зурлыгы</li>
              </ul>

              <p>
                Rails GraphQL контроллер ясау өчен без
                <a href="https://graphql-ruby.org"
                  ><code class="language-plaintext highlighter-rouge"
                    >graphql</code
                  >
                  гемны</a
                >
                кулланабыз.
              </p>

              <p>
                Алдарак әйтелгәнчә, безнең бер мутациябез булачак һәм ул кирәкле
                файл метамәгълүматны алып, кирәкле йөкләү көйләүләрне бирәчәк:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">module</span> <span class="nn">Mutations</span>
  <span class="k">class</span> <span class="nc">CreateDirectUpload</span> <span class="o">&lt;</span> <span class="no">BaseMutation</span>
    <span class="n">argument</span> <span class="ss">:filename</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>
    <span class="n">argument</span> <span class="ss">:byte_size</span><span class="p">,</span> <span class="no">Int</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>
    <span class="n">argument</span> <span class="ss">:checksum</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>
    <span class="n">argument</span> <span class="ss">:content_type</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>

    <span class="n">field</span> <span class="ss">:url</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="n">field</span> <span class="ss">:headers</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="s1">'JSON of required HTTP headers'</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="n">field</span> <span class="ss">:blob_id</span><span class="p">,</span> <span class="no">ID</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="n">field</span> <span class="ss">:signed_blob_id</span><span class="p">,</span> <span class="no">ID</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
                </div>
              </div>

              <p>
                <code class="language-plaintext highlighter-rouge"
                  >resolve</code
                >
                ысулы блобны төзәчәк һәм йөкләү көйләүләрне кайтарачак:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">module</span> <span class="nn">Mutations</span>
  <span class="k">class</span> <span class="nc">CreateDirectUpload</span> <span class="o">&lt;</span> <span class="no">BaseMutation</span>
    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">filename</span><span class="p">:,</span> <span class="n">byte_size</span><span class="p">:,</span> <span class="n">checksum</span><span class="p">:,</span> <span class="n">content_type</span><span class="p">:)</span>
      <span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_before_direct_upload!</span><span class="p">(</span>
        <span class="ss">filename: </span><span class="n">filename</span><span class="p">,</span>
        <span class="ss">byte_size: </span><span class="n">byte_size</span><span class="p">,</span>
        <span class="ss">checksum: </span><span class="n">checksum</span><span class="p">,</span>
        <span class="ss">content_type: </span><span class="n">content_type</span>
      <span class="p">)</span>

      <span class="p">{</span>
        <span class="ss">url: </span><span class="n">blob</span><span class="p">.</span><span class="nf">service_url_for_direct_upload</span><span class="p">,</span>
        <span class="ss">headers: </span><span class="n">blob</span><span class="p">.</span><span class="nf">service_headers_for_direct_upload</span><span class="p">.</span><span class="nf">to_json</span><span class="p">,</span>
        <span class="ss">blob_id: </span><span class="n">blob</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
        <span class="ss">signed_blob_id: </span><span class="n">blob</span><span class="p">.</span><span class="nf">signed_id</span>
      <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
                </div>
              </div>

              <p>
                Хәзер клиент бу мутацияне кулланып туры йөкләүне әзерли ала.
              </p>

              <h3 id="клиент-ягы">Клиент ягы</h3>
              <p>
                Мутациянең
                <code class="language-plaintext highlighter-rouge"
                  >checksum</code
                >-дан бөтен параметрларның мәгънәсе ачык күренелә. Контроль
                сумма юлы махсус ысулда төзеләргә тиеш. Бу ысул
                <a href="https://www.npmjs.com/package/@rails/activestorage"
                  ><code class="language-plaintext highlighter-rouge"
                    >@rails/activestorage</code
                  >
                  пакетында</a
                >
                урнашкан.
              </p>

              <p>
                <strong>Бонус!</strong> TypeScript өчен тип билгеләмәләр
                <a
                  href="https://www.npmjs.com/package/@types/rails__activestorage"
                  ><code class="language-plaintext highlighter-rouge"
                    >@types/rails__activestorage</code
                  >
                  пакетында</a
                >
                торалар.
              </p>

              <div class="language-ts highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">import</span> <span class="p">{</span> <span class="nx">FileChecksum</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@rails/activestorage/src/file_checksum</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">calculateChecksum</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">:</span> <span class="nx">File</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="p">(</span>
  <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="nx">FileChecksum</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">checksum</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nf">resolve</span><span class="p">(</span><span class="nx">checksum</span><span class="p">);</span>
    <span class="p">})</span>
  <span class="p">))</span>
<span class="p">);</span>
</code></pre>
                </div>
              </div>

              <p>
                Ant библиотекасындагы Upload компоненты
                <code class="language-plaintext highlighter-rouge"
                  >beforeUpload</code
                >
                функцияне ала, һәм без бу функциядә сервердан йөкләү көйләүләрне
                алачакбыз. Бу үрнәктә без бер файл гына йөклибез һәм көйләүләрне
                компонентның халәттә саклыйбыз.
              </p>
              <div class="language-ts highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">import</span> <span class="p">{</span> <span class="nx">RcFile</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">antd/lib/upload</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Test</span> <span class="kd">extends</span> <span class="nc">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="k">async</span> <span class="nf">beforeUpload</span><span class="p">(</span><span class="nx">file</span><span class="p">:</span> <span class="nx">RcFile</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// createDirectUploadMutation is a placeholder for your GraphQL request method</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">headers</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">createDirectUploadMutation</span><span class="p">({</span>
      <span class="na">checksum</span><span class="p">:</span> <span class="k">await</span> <span class="nf">calculateChecksum</span><span class="p">(</span><span class="nx">file</span><span class="p">),</span>
      <span class="na">filename</span><span class="p">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span>
      <span class="na">contentType</span><span class="p">:</span> <span class="nx">file</span><span class="p">.</span><span class="kd">type</span><span class="p">,</span>
      <span class="na">byteSize</span><span class="p">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">size</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nf">setState</span><span class="p">({</span> <span class="nx">url</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">headers</span><span class="p">)</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                Хәзер без туры йөкләү XHR таләп итә торган функцияне ясый
                алабыз:
              </p>
              <div class="language-ts highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">import</span> <span class="p">{</span> <span class="nx">RcCustomRequestOptions</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">antd/lib/upload/interface</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">BlobUpload</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@rails/activestorage/src/blob_upload</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Test</span> <span class="kd">extends</span> <span class="nc">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nf">customRequest</span><span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">RcCustomRequestOptions</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="nx">headers</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">upload</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlobUpload</span><span class="p">({</span>
      <span class="nx">file</span><span class="p">,</span>
      <span class="na">directUploadData</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">headers</span><span class="p">:</span> <span class="nx">headers</span> <span class="k">as</span> <span class="nb">Record</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="kr">string</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="nl">url</span><span class="p">:</span> <span class="nx">action</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">upload</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">progress</span><span class="dl">'</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">percent</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">/</span> <span class="nx">event</span><span class="p">.</span><span class="nx">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nf">onProgress</span><span class="p">({</span> <span class="nx">percent</span> <span class="p">},</span> <span class="nx">file</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">upload</span><span class="p">.</span><span class="nf">create</span><span class="p">((</span><span class="na">error</span><span class="p">:</span> <span class="nb">Error</span><span class="p">,</span> <span class="na">response</span><span class="p">:</span> <span class="nx">object</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nf">onError</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nf">onSuccess</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                Аннары без
                <code class="language-plaintext highlighter-rouge"
                  >beforeUpload</code
                >
                һәм
                <code class="language-plaintext highlighter-rouge"
                  >customRequest</code
                >
                функцияләрне Upload компонентның һукларында куллана алабыз:
              </p>
              <div class="language-tsx highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="kd">class</span> <span class="nc">Test</span> <span class="kd">extends</span> <span class="nc">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nf">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return </span><span class="p">(</span>
      <span class="p">&lt;</span><span class="nc">Upload</span>
        <span class="na">method</span><span class="p">=</span><span class="s">'put'</span> <span class="c1">// important!</span>
        <span class="na">multiple</span><span class="p">=</span><span class="si">{</span><span class="kc">false</span><span class="si">}</span>
        <span class="na">beforeUpload</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">file</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nf">beforeUpload</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span><span class="si">}</span>
        <span class="na">action</span><span class="p">=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span>
        <span class="na">customRequest</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">options</span><span class="p">):</span> <span class="k">void</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nf">customRequest</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span><span class="si">}</span>
      <span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nc">Button</span><span class="p">&gt;</span>Click to Upload!<span class="p">&lt;/</span><span class="nc">Button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nc">Upload</span><span class="p">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                Rails-ның юлларын яңартырга онытмагыз. Әгәр сез бөтен таләпләрне
                React-ка юнәлешсәгез:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="n">match</span> <span class="s1">'*path'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'react#index'</span><span class="p">,</span> <span class="ss">via: :all</span>
</code></pre>
                </div>
              </div>

              <p>Сез бу кагыйдән Active Storage юлларны шулай чыгара аласыз:</p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="n">match</span> <span class="s1">'*path'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'react#index'</span><span class="p">,</span> <span class="ss">via: :all</span><span class="p">,</span>
  <span class="ss">constraints: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span> <span class="n">req</span><span class="p">.</span><span class="nf">path</span><span class="p">.</span><span class="nf">exclude?</span> <span class="s1">'rails/active_storage'</span> <span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                Нәкъ менә шулай. Туры йөкләүләрегездә бәхетле булуыгызны телим!
              </p>
            </div>
          </article>
        </section>
      </div>

      <footer
        class="bg-[linear-gradient(120deg,var(--tw-gradient-stops))] from-[#155799] to-ghaze-600 text-white mt-4 pt-4 pb-4"
      >
        <ul class="space-x-4 flex justify-center">
          <li class="inline">
            <a lang="en" href="/blog/react-ant-rails-graphql-direct-upload"
              >English</a
            >
          </li>

          <li class="inline">
            <a
              lang="ru"
              href="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-rails-graphql-%D0%BF%D1%80%D1%8F%D0%BC%D0%B0%D1%8F-%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0"
              >Русский</a
            >
          </li>

          <li class="inline">
            <a
              lang="tt"
              href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/react-ant-graphql-rails-%D1%82%D1%83%D1%80%D1%8B-%D0%B9%D3%A9%D0%BA%D0%BB%D3%99%D2%AF"
              >Татарча</a
            >
          </li>
        </ul>
      </footer>
    </div>
  </body>
</html>
