<!DOCTYPE html>

<html lang="ru">
  <head>
    <meta charset="UTF-8" />

    <link
      rel="alternate"
      hreflang="en"
      href="https://imustafin.tatar/blog/optimizing-heroku-postgres-for-free-tier"
    />

    <link
      rel="alternate"
      hreflang="ru"
      href="https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%B1%D0%B4-heroku-postgres-%D0%B4%D0%BB%D1%8F-%D0%B1%D0%B5%D1%81%D0%BF%D0%BB%D0%B0%D1%82%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F"
    />

    <link
      rel="alternate"
      hreflang="tt"
      href="https://imustafin.tatar/tt/%D0%B1%D0%BB%D0%BE%D0%B3/heroku-postgres-%D0%B1%D0%BD-%D0%B1%D1%83%D1%88%D0%BB%D0%B0%D0%B9-%D0%BA%D1%83%D0%BB%D0%BB%D0%B0%D0%BD%D1%83-%D3%A9%D1%87%D0%B5%D0%BD-%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B0%D0%BB%D1%8C%D0%BB%D3%99%D1%88%D1%82%D0%B5%D1%80%D2%AF"
    />

    <link
      rel="alternate"
      type="application/atom+xml"
      href="https://imustafin.tatar/ru/feed.xml"
      title="Посты на русском"
    />
    <link
      rel="alternate"
      type="application/atom+xml"
      href="https://imustafin.tatar/feed-multilang.xml"
      title="Posts in all languages"
    />

    <!-- Begin Jekyll SEO tag v2.8.0 -->
    <title>
      Оптимизация БД Heroku Postgres для бесплатного использования |
      imustafin.tatar
    </title>
    <meta name="generator" content="Jekyll v4.3.3" />
    <meta
      property="og:title"
      content="Оптимизация БД Heroku Postgres для бесплатного использования"
    />
    <meta name="author" content="Ильгиз Мустафин" />
    <meta property="og:locale" content="ru" />
    <meta
      name="description"
      content="Оптимизация схемы реляционной базы данных для соответствия бесплатному уровню Heroku Postgres на примере приложения SIBrowser."
    />
    <meta
      property="og:description"
      content="Оптимизация схемы реляционной базы данных для соответствия бесплатному уровню Heroku Postgres на примере приложения SIBrowser."
    />
    <meta
      property="twitter:description"
      content="Оптимизация схемы реляционной базы данных для соответствия бесплатному уровню Heroku Postgres на примере приложения SIBrowser."
    />
    <link
      rel="canonical"
      href="https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%B1%D0%B4-heroku-postgres-%D0%B4%D0%BB%D1%8F-%D0%B1%D0%B5%D1%81%D0%BF%D0%BB%D0%B0%D1%82%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F"
    />
    <meta
      property="og:url"
      content="https://imustafin.tatar/ru/%D0%B1%D0%BB%D0%BE%D0%B3/%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%B1%D0%B4-heroku-postgres-%D0%B4%D0%BB%D1%8F-%D0%B1%D0%B5%D1%81%D0%BF%D0%BB%D0%B0%D1%82%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F"
    />
    <meta property="og:site_name" content="imustafin.tatar" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2021-07-13T00:00:00+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta
      property="twitter:title"
      content="Оптимизация БД Heroku Postgres для бесплатного использования"
    />
    <!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#157878" />
    <link rel="stylesheet" href="/assets/css/main.css" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />
    <meta name="apple-mobile-web-app-title" content="imustafin.tatar" />
    <meta name="application-name" content="imustafin.tatar" />
    <meta name="msapplication-TileColor" content="#00aba9" />
    <meta name="theme-color" content="#ffffff" />
  </head>
  <body class="text-tcolor" vocab="https://schema.org/" typeof="WebPage">
    <div class="min-h-svh flex flex-col">
      <section
        class="bg-[linear-gradient(120deg,var(--tw-gradient-stops))] from-[#155799] to-ghaze-600 text-white text-center"
      >
        <span class="text-l sm:text-xl font-serif font-semibold mt-2 mb-2 mx-2">
          <a href="/ru/"> Личный сайт Мустафина Ильгиза </a>
        </span>

        <div class="flex flex-col lg:flex-row">
          <div class="flex-1"></div>

          <ul class="flex-[2] mb-2 space-x-2">
            <li class="inline"><a href="/ru/">Главная</a></li>

            <li class="inline">
              <a href="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/">Блог</a>
            </li>

            <li class="inline">
              <a href="/ru/%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D1%8B/"
                >Проекты</a
              >
            </li>

            <li class="inline">
              <a href="/ru/%D0%B8%D0%BB%D1%8C%D0%B3%D0%B8%D0%B7">Обо мне</a>
            </li>
          </ul>

          <ul class="flex-1 space-x-2 mb-2">
            <li class="inline">
              <a lang="en" href="/blog/optimizing-heroku-postgres-for-free-tier"
                >English</a
              >
            </li>

            <li class="inline">
              <a
                lang="ru"
                href="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%B1%D0%B4-heroku-postgres-%D0%B4%D0%BB%D1%8F-%D0%B1%D0%B5%D1%81%D0%BF%D0%BB%D0%B0%D1%82%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F"
                >Русский</a
              >
            </li>

            <li class="inline">
              <a
                lang="tt"
                href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/heroku-postgres-%D0%B1%D0%BD-%D0%B1%D1%83%D1%88%D0%BB%D0%B0%D0%B9-%D0%BA%D1%83%D0%BB%D0%BB%D0%B0%D0%BD%D1%83-%D3%A9%D1%87%D0%B5%D0%BD-%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B0%D0%BB%D1%8C%D0%BB%D3%99%D1%88%D1%82%D0%B5%D1%80%D2%AF"
                >Татарча</a
              >
            </li>
          </ul>
        </div>
      </section>

      <div class="flex-1 p-2 md:pt-4">
        <section class="max-w-prose mx-auto">
          <nav class="mb-4">
            <ol
              property="breadcrumb"
              class="breadcrumbs"
              vocab="https://schema.org/"
              typeof="BreadcrumbList"
            >
              <li
                class="inline-block"
                property="itemListElement"
                typeof="ListItem"
              >
                <a property="item" typeof="WebPage" href="/ru/" class="vlink">
                  <meta
                    property="name"
                    content="Мустафин Ильгиз: аспирант в программной инженерии"
                  />
                  <span property="alternateName">Главная</span>
                </a>

                <meta property="position" content="1" />
              </li>

              <li
                class="inline-block text-[#afbbc4] before:content-['/']"
                property="itemListElement"
                typeof="ListItem"
              >
                <a
                  property="item"
                  typeof="WebPage"
                  href="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/"
                  class="vlink"
                >
                  <span property="name">Блог</span>
                </a>

                <meta property="position" content="2" />
              </li>

              <li
                class="inline-block text-[#afbbc4] before:content-['/']"
                property="itemListElement"
                typeof="ListItem"
              >
                <span
                  property="item"
                  typeof="WebPage"
                  resource="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%B1%D0%B4-heroku-postgres-%D0%B4%D0%BB%D1%8F-%D0%B1%D0%B5%D1%81%D0%BF%D0%BB%D0%B0%D1%82%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F"
                  class="text-tcolor"
                >
                  <span property="name"
                    >Оптимизация БД Heroku Postgres для бесплатного
                    использования</span
                  >
                </span>

                <meta property="position" content="3" />
              </li>
            </ol>
          </nav>

          <article
            class="max-w-prose"
            itemscope
            itemtype="http://schema.org/BlogPosting"
          >
            <header>
              <div class="prose">
                <h1 itemprop="name headline">
                  Оптимизация БД Heroku Postgres для бесплатного использования
                </h1>
              </div>
              <div class="italic">
                <time
                  class="inline-block mr-4"
                  datetime="2021-07-13T00:00:00+00:00"
                  itemprop="datePublished"
                >
                  13 июля 2021
                </time>

                <span class="inline-block">
                  Последнее обновление:
                  <time
                    datetime="2021-09-01T00:00:00+00:00"
                    itemprop="dateModified"
                  >
                    1 сентября 2021
                  </time>
                </span>
              </div>
            </header>

            <div itemprop="articleBody" class="prose mt-4">
              <p>
                Оптимизация схемы реляционной базы данных для соответствия
                бесплатному уровню Heroku Postgres на примере приложения
                SIBrowser.
              </p>

              <p>
                <a href="https://www.sibrowser.ru">SIBrowser</a> — это сайт, на
                котором можно удобно искать пакеты для
                <a href="https://vladimirkhil.com/si/game"
                  >Своей игры (SIGame)</a
                >. В последнее время я работал над этим проектом. Мы с друзьями
                часто играем в свою игру, и нам постоянно надо находить хорошие
                пакеты для вечера. Чтобы упростить эту задачу, я решил сделать
                сайт, который собирает пакеты из интернета и показывает
                различную статистику.
              </p>

              <p>
                Сайт сделан на
                <a href="https://rubyonrails.org/">Ruby on Rails</a> и
                разворачивается на <a href="https://heroku.com">Heroku</a>.
                Чтобы сэкономить, я использую бесплатный уровень
                <a href="https://elements.heroku.com/addons/heroku-postgresql"
                  >Heroku Postgres</a
                >, который даёт 10к строчек и 1ГБ хранилища и бесплатный уровень
                <a href="https://elements.heroku.com/addons/heroku-redis"
                  >Heroku Redis</a
                >, который даёт 25МБ хранилища.
              </p>

              <p>
                Для фонового сбора пакетов я использую
                <a href="https://sidekiq.org/">Sidekiq</a> с Heroku Redis-ом как
                хранилище состояния очереди. Для этой задачи пока вполне хватает
                бесплатного уровня Heroku Redis: сейчас используется &lt; 1МБ из
                25МБ бесплатных.
              </p>

              <p>
                Однако, ограничение бесплатного уровня Heroku Postgres в 10к
                строк очень заметно в этом проекте.
              </p>

              <h2 id="оптимизация-базы-данных-по-стоимости">
                Оптимизация базы данных по стоимости
              </h2>
              <p>
                Чтобы уместить приложение в ограничения бесплатного уровня
                Heroku Postgres, можно произвести несколько изменений в
                архитектуру базы данных. Взглянем на высокоуровневую ER-модель
                проекта.
              </p>

              <p>
                <object
                  data="/uml/d9e5df1a93b34793c2c9489f1f85282f.svg"
                  type="image/svg+xml"
                  class="plantuml"
                ></object>
              </p>

              <p>
                Эта диаграмма более или менее представляет предметную область
                приложения. Автор имеет ноль или больше пакетов. Пакет может
                иметь ноль или больше тегов и раундов. Раунд может иметь ноль
                или больше тем. Тема может иметь ноль или больше вопросов.
              </p>

              <p>
                В идеале нам бы хотелось иметь нормализованную базу данных в
                третьей или четвёртой нормальной форме. Однако, каждый шаг
                нормализации будет пораждать всё больше и больше строк.
              </p>

              <p>
                В зависимости от того, какие запросы мы хотим поддерживать в
                нашей БД, мы можем денормализовать некоторые сущности.
              </p>

              <h2 id="шаг-1-главная-таблица">Шаг 1: главная таблица</h2>
              <p>
                Из ER-диаграммы мы видим, что
                <code class="language-plaintext highlighter-rouge">Пакет</code>
                является центральной сущностью. В самом деле, мы можем
                попробовать сделать все остальные сущности аттрибутами сущности
                <code class="language-plaintext highlighter-rouge">Пакет</code>.
              </p>

              <p>
                Мы можем хранить теги и авторов просто как массивы строк.
                Цепочка раунды-темы-вопросы, которую мы будем просто называть
                <em>структурой</em>, может быть представлена как вложенные
                массивы или хеши.
              </p>

              <p>
                Для сохранения объектов в базе данных мы можем использовать
                метод <a href="serialize">serialize</a> из Active Record. В этом
                случае типы полей в БД должны быть
                <code class="language-plaintext highlighter-rouge">text</code>
                или
                <code class="language-plaintext highlighter-rouge">string</code
                >.
              </p>

              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">class</span> <span class="nc">Package</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">serialize</span> <span class="ss">:authors</span><span class="p">,</span> <span class="no">Array</span>
  <span class="n">serialize</span> <span class="ss">:structure</span><span class="p">,</span> <span class="no">Hash</span>
  <span class="n">serialize</span> <span class="ss">:tags</span><span class="p">,</span> <span class="no">Array</span>
<span class="k">end</span>
</code></pre>
                </div>
              </div>

              <p>
                Такой подход позволяет сжать всю ER-модель всего в одну таблицу.
                Однако, база данных становится ненормализованной, у нас остаётся
                только первичный ключ
                <code class="language-plaintext highlighter-rouge">id</code> для
                пакетов.
              </p>

              <p>
                Далее мы покажем, что это не страшно и мы можем реализовать
                несколько видов запросов. Мы всё ещё можем получить список всех
                пакетов или информацию о конкретном пакете по его ключу. Мы даже
                можем упорядочивать пакеты по авторам, если массив авторов
                всегда будет сортироваться перед записью в БД.
              </p>

              <h2 id="шаг-2-поиск-по-авторам-используя-индексы-по-jsonb">
                Шаг 2: Поиск по авторам, используя индексы по JSONB
              </h2>
              <p>
                Так как бесплатный уровень Heroku Postgres не ограничивает
                количество индексов, мы можем построить инвертированный индекс
                по столбцы
                <code class="language-plaintext highlighter-rouge"
                  >authors</code
                >
                для эффективного поиска, но сначала нам нужно изменить тип
                столбца на JSONB.
              </p>

              <p>
                После того, как столбцы были превращены в JSONB, нам не нужно
                явно указывать AR, что эти поля нужно сериализовывать методом
                <code class="language-plaintext highlighter-rouge"
                  >serialize</code
                >. Значения и так будут автоматически превращаться в и из JSONB.
              </p>

              <p>
                Мы будем делать регистронезависимый поиск по авторам, потому что
                авторы часто используют заглавные буквы по-разному в разных
                пакетах.
              </p>

              <p>Сначала нам нужно построить индекс:</p>

              <div class="language-sql highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">authors_icase_index</span>
<span class="k">ON</span> <span class="n">packages</span>
<span class="k">USING</span> <span class="n">gin</span> <span class="p">(</span><span class="k">LOWER</span><span class="p">(</span><span class="n">authors</span><span class="p">::</span><span class="nb">text</span><span class="p">)::</span><span class="n">jsonb</span><span class="p">);</span>
</code></pre>
                </div>
              </div>

              <p>
                Чтобы этот индекс использовался, запросы должны использовать
                точно такое же выражение:
              </p>

              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">class</span> <span class="nc">Package</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">scope</span> <span class="ss">:by_author</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'LOWER(authors::text)::jsonb @&gt; to_jsonb(LOWER(?)::text)'</span><span class="p">,</span> <span class="n">author</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
                </div>
              </div>

              <p>
                Мы можем проверить, что индекс используется с помощью
                <code class="language-plaintext highlighter-rouge">EXPLAIN</code
                >:
              </p>
              <div class="language-sql highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">EXPLAIN</span> <span class="k">SELECT</span> <span class="nv">"packages"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"packages"</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="k">LOWER</span><span class="p">(</span><span class="n">authors</span><span class="p">::</span><span class="nb">text</span><span class="p">)::</span><span class="n">jsonb</span> <span class="o">@&gt;</span> <span class="n">to_jsonb</span><span class="p">(</span><span class="k">LOWER</span><span class="p">(</span><span class="s1">'Timur'</span><span class="p">)::</span><span class="nb">text</span><span class="p">));</span>

                                    <span class="n">QUERY</span> <span class="n">PLAN</span>                                    
<span class="c1">----------------------------------------------------------------------------------</span>
 <span class="n">Bitmap</span> <span class="n">Heap</span> <span class="n">Scan</span> <span class="k">on</span> <span class="n">packages</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">8</span><span class="p">.</span><span class="mi">08</span><span class="p">..</span><span class="mi">36</span><span class="p">.</span><span class="mi">14</span> <span class="k">rows</span><span class="o">=</span><span class="mi">9</span> <span class="n">width</span><span class="o">=</span><span class="mi">677</span><span class="p">)</span>
   <span class="k">Recheck</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">((</span><span class="k">lower</span><span class="p">((</span><span class="n">authors</span><span class="p">)::</span><span class="nb">text</span><span class="p">))::</span><span class="n">jsonb</span> <span class="o">@&gt;</span> <span class="n">to_jsonb</span><span class="p">(</span><span class="s1">'timur'</span><span class="p">::</span><span class="nb">text</span><span class="p">))</span>
   <span class="o">-&gt;</span>  <span class="n">Bitmap</span> <span class="k">Index</span> <span class="n">Scan</span> <span class="k">on</span> <span class="n">authors_icase_index</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">8</span><span class="p">.</span><span class="mi">07</span> <span class="k">rows</span><span class="o">=</span><span class="mi">9</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">((</span><span class="k">lower</span><span class="p">((</span><span class="n">authors</span><span class="p">)::</span><span class="nb">text</span><span class="p">))::</span><span class="n">jsonb</span> <span class="o">@&gt;</span> <span class="n">to_jsonb</span><span class="p">(</span><span class="s1">'timur'</span><span class="p">::</span><span class="nb">text</span><span class="p">))</span>
</code></pre>
                </div>
              </div>

              <p>
                Однако, у нас нет численного первичного ключа для автора. Авторы
                определяются только по их имени в нижнем регистре. В таком
                случае, чтобы реализовать страницу автора, на которой будут
                отображаться пакеты этого автора, мы можем вставить имя автора
                прямо в путь к странице.
              </p>

              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="c1"># routes.rb</span>
<span class="n">resources</span> <span class="ss">:authors</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">],</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">id: </span><span class="sr">/.+/</span> <span class="p">}</span>
</code></pre>
                </div>
              </div>

              <p>
                Параметр
                <code class="language-plaintext highlighter-rouge"
                  >constraints</code
                >
                позволит Rails понимать авторов с пробелами и косыми чертами в
                имени. Например, в системе есть автор
                <code class="language-plaintext highlighter-rouge"
                  >https://vk.com/sigamepack</code
                >, а страница этого автора доступна по адресу
                <a
                  href="https://www.sibrowser.ru/authors/https:%2F%2Fvk.com%2Fsigamepack"
                  >https://www.sibrowser.ru/authors/https://vk.com/sigamepack</a
                >.
              </p>

              <h2 id="шаг-3-полнотекстовый-поиск-по-jsonb-столбцам">
                Шаг 3: Полнотекстовый поиск по JSONB столбцам
              </h2>
              <p>
                Также мы можем производить полнотекстовый поиск по столбцам с
                типом JSONB. Есть
                <a
                  href="https://pganalyze.com/blog/full-text-search-ruby-rails-postgres"
                  >хорошая статья Ли Халлидея</a
                >, которая описывает реализацию полнотекстового поиска с
                использованием гема
                <a href="https://rubygems.org/gems/pg_search">pg_search</a> и
                типа
                <code class="language-plaintext highlighter-rouge"
                  >ts_vector</code
                >
                в Postgres.
              </p>

              <p>
                Здесь я покажу как можно использовать такой же подход для поиска
                по JSONB столбцам.
              </p>

              <p>
                Генерируемый столбец
                <code class="language-plaintext highlighter-rouge"
                  >searchable</code
                >
                может давать веса значениям типа JSONB. Функция
                <code class="language-plaintext highlighter-rouge"
                  >to_tsvector</code
                >
                может принимать JSONB объект:
              </p>

              <div class="language-sql highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">packages</span>
<span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">searchable</span> <span class="n">tsvector</span> <span class="k">GENERATED</span> <span class="n">ALWAYS</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">'russian'</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">''</span><span class="p">)),</span> <span class="s1">'A'</span><span class="p">)</span> <span class="o">||</span>
  <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">'russian'</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">authors</span><span class="p">,</span> <span class="s1">'{}'</span><span class="p">)),</span> <span class="s1">'B'</span><span class="p">)</span> <span class="o">||</span>
  <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">'russian'</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="s1">'{}'</span><span class="p">)),</span> <span class="s1">'B'</span><span class="p">)</span> <span class="o">||</span>
  <span class="c1">-- Названия раундов</span>
  <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">'russian'</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">jsonb_path_query_array</span><span class="p">(</span><span class="k">structure</span><span class="p">,</span> <span class="s1">'$[*].name'</span><span class="p">),</span> <span class="s1">'{}'</span><span class="p">)),</span> <span class="s1">'B'</span><span class="p">)</span> <span class="o">||</span>
  <span class="c1">-- Названия тем</span>
  <span class="n">setweight</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">'russian'</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">jsonb_path_query_array</span><span class="p">(</span><span class="k">structure</span><span class="p">,</span> <span class="s1">'$[*].themes[*].name'</span><span class="p">),</span> <span class="s1">'{}'</span><span class="p">)),</span> <span class="s1">'B'</span><span class="p">)</span>
<span class="p">)</span> <span class="n">STORED</span><span class="p">;</span>
</code></pre>
                </div>
              </div>

              <p>
                Этот пример показывает как добавить глубоко вложенные значения в
                индекс, используя JSON пути.
              </p>

              <p>
                Настройки
                <code class="language-plaintext highlighter-rouge"
                  >pg_search</code
                >
                остаются такими же:
              </p>
              <div class="language-ruby highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="k">class</span> <span class="nc">Package</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">PgSearch</span><span class="o">::</span><span class="no">Model</span>
  
  <span class="n">pg_search_scope</span> <span class="ss">:search_freetext</span><span class="p">,</span>
    <span class="ss">against: :searchable</span><span class="p">,</span> <span class="c1"># не используется если указан tsvector_column</span>
    <span class="ss">using: </span><span class="p">{</span>
      <span class="ss">tsearch: </span><span class="p">{</span>
        <span class="ss">dictionary: </span><span class="s1">'russian'</span><span class="p">,</span>
        <span class="ss">tsvector_column: </span><span class="s1">'searchable'</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="k">end</span>
</code></pre>
                </div>
              </div>

              <h2 id="заключение">Заключение</h2>
              <p>В этой статье мы рассмотрели такие темы, как:</p>
              <ul>
                <li>
                  Ограничения в бесплатном уровне Heroku Postgres и как c ними
                  работать
                </li>
                <li>Денормализация БД c помощью JSONB</li>
                <li>Построение инвертированного индекса по значениям JSONB</li>
                <li>
                  Полнотекстовый поиск по строкам, вложенным в JSONB объекты
                </li>
              </ul>
            </div>
          </article>
        </section>
      </div>

      <footer
        class="bg-[linear-gradient(120deg,var(--tw-gradient-stops))] from-[#155799] to-ghaze-600 text-white mt-4 pt-4 pb-4"
      >
        <ul class="space-x-4 flex justify-center">
          <li class="inline">
            <a lang="en" href="/blog/optimizing-heroku-postgres-for-free-tier"
              >English</a
            >
          </li>

          <li class="inline">
            <a
              lang="ru"
              href="/ru/%D0%B1%D0%BB%D0%BE%D0%B3/%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%B1%D0%B4-heroku-postgres-%D0%B4%D0%BB%D1%8F-%D0%B1%D0%B5%D1%81%D0%BF%D0%BB%D0%B0%D1%82%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F"
              >Русский</a
            >
          </li>

          <li class="inline">
            <a
              lang="tt"
              href="/tt/%D0%B1%D0%BB%D0%BE%D0%B3/heroku-postgres-%D0%B1%D0%BD-%D0%B1%D1%83%D1%88%D0%BB%D0%B0%D0%B9-%D0%BA%D1%83%D0%BB%D0%BB%D0%B0%D0%BD%D1%83-%D3%A9%D1%87%D0%B5%D0%BD-%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B0%D0%BB%D1%8C%D0%BB%D3%99%D1%88%D1%82%D0%B5%D1%80%D2%AF"
              >Татарча</a
            >
          </li>
        </ul>
      </footer>
    </div>
  </body>
</html>
